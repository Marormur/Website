<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="textEditor.title">Texteditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = Object.assign({}, window.tailwind.config, { darkMode: 'class' });
    </script>
    <script src="i18n.js"></script>
    <style>
        :root {
            color-scheme: light;
            --editor-body-bg: #fafafa;
            --editor-text: #111827;
            --editor-toolbar-bg: #f5f5f5;
            --editor-toolbar-border: #d1d5db;
            --editor-toolbar-button-bg: #ffffff;
            --editor-toolbar-button-hover: #e5e7eb;
            --editor-toolbar-button-border: #d1d5db;
            --editor-surface-bg: #ffffff;
        }

        .dark {
            color-scheme: dark;
            --editor-body-bg: #0f172a;
            --editor-text: #e5e7eb;
            --editor-toolbar-bg: #1f2937;
            --editor-toolbar-border: #374151;
            --editor-toolbar-button-bg: #111827;
            --editor-toolbar-button-hover: #1f2937;
            --editor-toolbar-button-border: #475569;
            --editor-surface-bg: #111827;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            display: flex;
            flex-direction: column;
            font-family: sans-serif;
            background: var(--editor-body-bg);
            color: var(--editor-text);
        }
        #toolbar {
            flex: 0 0 auto;
            background: var(--editor-toolbar-bg);
            padding: 8px;
            border-bottom: 1px solid var(--editor-toolbar-border);
        }
        #toolbar button {
            margin-right: 4px;
            padding: 4px 8px;
            font-size: 14px;
            border: 1px solid var(--editor-toolbar-button-border);
            background: var(--editor-toolbar-button-bg);
            cursor: pointer;
            color: inherit;
        }
        #toolbar button:hover {
            background: var(--editor-toolbar-button-hover);
        }
        #file-status {
            flex: 0 0 auto;
            padding: 8px 16px;
            border-bottom: 1px solid var(--editor-toolbar-border);
            background: var(--editor-body-bg);
            color: var(--editor-text);
            font-size: 14px;
            opacity: 0.75;
            display: none;
        }
        #file-status.active {
            display: block;
        }
        #editor {
            flex: 1 1 auto;
            padding: 10px;
            overflow-y: auto;
            background: var(--editor-surface-bg);
            outline: none;
            border: none;
        }
    </style>
</head>

<body class="dialog-content" onclick="onClick()">
    <div id="toolbar">
        <!-- Basic formatting -->
        <button type="button" onclick="execCmd('bold')" title="Fett"
            data-i18n-title="textEditor.toolbar.bold" data-i18n-aria-label="textEditor.toolbar.bold">
            <strong>B</strong>
        </button>
        <button type="button" onclick="execCmd('italic')" title="Kursiv"
            data-i18n-title="textEditor.toolbar.italic" data-i18n-aria-label="textEditor.toolbar.italic">
            <em>I</em>
        </button>
        <button type="button" onclick="execCmd('underline')" title="Unterstrichen"
            data-i18n-title="textEditor.toolbar.underline" data-i18n-aria-label="textEditor.toolbar.underline">
            <u>U</u>
        </button>
        <button type="button" onclick="execCmd('strikeThrough')" title="Durchgestrichen"
            data-i18n-title="textEditor.toolbar.strikeThrough" data-i18n-aria-label="textEditor.toolbar.strikeThrough">
            <s>S</s>
        </button>
        <!-- Lists -->
        <button type="button" onclick="execCmd('insertUnorderedList')" title="Ungeordnete Liste"
            data-i18n-title="textEditor.toolbar.unorderedList"
            data-i18n-aria-label="textEditor.toolbar.unorderedList">
            <span aria-hidden="true">•</span>
            <span class="ml-1" data-i18n="textEditor.toolbar.unorderedList">Ungeordnete Liste</span>
        </button>
        <button type="button" onclick="execCmd('insertOrderedList')" title="Geordnete Liste"
            data-i18n-title="textEditor.toolbar.orderedList"
            data-i18n-aria-label="textEditor.toolbar.orderedList">
            <span aria-hidden="true">1.</span>
            <span class="ml-1" data-i18n="textEditor.toolbar.orderedList">Geordnete Liste</span>
        </button>
        <!-- Undo/Redo -->
        <button type="button" onclick="execCmd('undo')" title="Rückgängig"
            data-i18n-title="textEditor.toolbar.undo" data-i18n-aria-label="textEditor.toolbar.undo">
            <span data-i18n="textEditor.toolbar.undo">Undo</span>
        </button>
        <button type="button" onclick="execCmd('redo')" title="Wiederholen"
            data-i18n-title="textEditor.toolbar.redo" data-i18n-aria-label="textEditor.toolbar.redo">
            <span data-i18n="textEditor.toolbar.redo">Redo</span>
        </button>
        <!-- File operations -->
        <button type="button" onclick="clearEditor()" title="Neues Dokument"
            data-i18n-title="textEditor.toolbar.clear" data-i18n-aria-label="textEditor.toolbar.clear">
            <span data-i18n="textEditor.toolbar.clear">Neu</span>
        </button>
        <button type="button" onclick="openFile()" title="Datei öffnen"
            data-i18n-title="textEditor.toolbar.open" data-i18n-aria-label="textEditor.toolbar.open">
            <span data-i18n="textEditor.toolbar.open">Öffnen</span>
        </button>
        <button type="button" onclick="saveFile()" title="Speichern"
            data-i18n-title="textEditor.toolbar.save" data-i18n-aria-label="textEditor.toolbar.save">
            <span data-i18n="textEditor.toolbar.save">Speichern</span>
        </button>
        <!-- Hidden file input for opening files -->
        <input type="file" id="file-input" accept=".txt,.html" style="display:none">
    </div>
    <div id="file-status"></div>
    <div id="editor" contenteditable="true"></div>
    <script>
        function applyTheme(isDark) {
            document.documentElement.classList.toggle('dark', !!isDark);
        }
        (function initThemeSync() {
            try {
                const parentRoot = window.parent.document.documentElement;
                const updateFromParent = () => applyTheme(parentRoot.classList.contains('dark'));
                updateFromParent();
                const observer = new MutationObserver(updateFromParent);
                observer.observe(parentRoot, { attributes: true, attributeFilter: ['class'] });
            } catch (err) {
                const mediaQuery = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
                applyTheme(mediaQuery ? mediaQuery.matches : false);
                if (mediaQuery) {
                    const listener = (event) => applyTheme(event.matches);
                    if (typeof mediaQuery.addEventListener === 'function') {
                        mediaQuery.addEventListener('change', listener);
                    } else if (typeof mediaQuery.addListener === 'function') {
                        mediaQuery.addListener(listener);
                    }
                }
            }
        })();
        // Den übergeordneten Dialog identifizieren, damit das Fenster im Fokus bleibt
        const dialog = window.parent.loaded(window.frameElement);
        // Bring the editor window to the front whenever this iframe gains focus (e.g. click or tab inside editor).
        window.addEventListener('focus', () => {
            try {
                dialog.refocus();
            } catch (e) {
                console.error('Error refocusing dialog from text editor:', e);
            }
        });
        function onClick() {
            dialog.refocus();
        }
        const appI18n = window.appI18n || {
            translate: (key) => key,
            applyTranslations: () => { },
            getLanguagePreference: () => 'system',
            getActiveLanguage: () => 'en',
            setLanguagePreference: () => { }
        };
        const statusBar = document.getElementById('file-status');
        let statusState = null;
        let currentRemoteFile = null;
        function applyStatusState() {
            if (!statusBar) {
                return;
            }
            if (!statusState) {
                statusBar.textContent = '';
                statusBar.classList.remove('active');
                statusBar.removeAttribute('data-i18n');
                statusBar.removeAttribute('data-i18n-params');
                return;
            }
            if (statusState.type === 'i18n') {
                statusBar.setAttribute('data-i18n', statusState.key);
                if (statusState.params) {
                    statusBar.setAttribute('data-i18n-params', JSON.stringify(statusState.params));
                } else {
                    statusBar.removeAttribute('data-i18n-params');
                }
                statusBar.textContent = appI18n.translate(statusState.key, statusState.params);
                appI18n.applyTranslations(statusBar);
            } else {
                statusBar.removeAttribute('data-i18n');
                statusBar.removeAttribute('data-i18n-params');
                statusBar.textContent = statusState.text;
            }
            statusBar.classList.add('active');
        }
        function setStatusPlain(text) {
            if (!text) {
                clearStatus();
                return;
            }
            statusState = { type: 'plain', text };
            applyStatusState();
        }
        function setStatusLocalized(key, params) {
            statusState = { type: 'i18n', key, params: params || undefined };
            applyStatusState();
        }
        function clearStatus() {
            statusState = null;
            applyStatusState();
        }
        function updateDocumentTitle() {
            if (currentRemoteFile && currentRemoteFile.fileName) {
                document.title = appI18n.translate('textEditor.documentTitleWithFile', { fileName: currentRemoteFile.fileName });
            } else {
                document.title = appI18n.translate('textEditor.documentTitle');
            }
        }
        updateDocumentTitle();
        function formatFileLabel(meta = {}) {
            const parts = [];
            if (meta.repo) {
                parts.push(meta.repo);
            }
            if (meta.path) {
                parts.push(meta.path);
            } else if (meta.fileName) {
                parts.push(meta.fileName);
            }
            return parts.join(' / ');
        }
        function execCmd(command) {
            document.execCommand(command, false, null);
            document.getElementById('editor').focus();
        }
        function clearEditor() {
            document.getElementById('editor').innerHTML = '';
            // Entferne gespeicherten Inhalt aus localStorage
            localStorage.removeItem('textEditorContent');
            currentRemoteFile = null;
            updateDocumentTitle();
            clearStatus();
        }
        function saveFile() {
            // Text ohne HTML-Auszeichnungen speichern
            const content = document.getElementById('editor').innerText;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Verwende den ersten Teil des Inhalts als Dateiname oder fallback
            const firstLine = content.split('\n')[0] || 'text';
            const sanitized = firstLine.trim().substring(0, 20).replace(/[^a-zA-Z0-9-_]/g, '') || 'text';
            a.download = `${sanitized}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function openFile() {
            const input = document.getElementById('file-input');
            input.click();
        }
        // Listener um Datei einzulesen
        document.getElementById('file-input').addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const content = e.target.result;
                // Wenn es sich um HTML handelt, setzen wir innerHTML, ansonsten innerText
                if (file.name.endsWith('.html')) {
                    document.getElementById('editor').innerHTML = content;
                } else {
                    // Entkomme HTML, damit es als reiner Text erscheint
                    document.getElementById('editor').innerText = content;
                }
                currentRemoteFile = { fileName: file.name };
                updateDocumentTitle();
                setStatusPlain(file.name);
            };
            reader.readAsText(file);
            // Zurücksetzen der Eingabe für zukünftige Öffnungen derselben Datei
            event.target.value = '';
        });
        // Speicher den Text fortlaufend im localStorage
        const editor = document.getElementById('editor');
        editor.addEventListener('input', function () {
            localStorage.setItem('textEditorContent', editor.innerHTML);
        });
        // Beim Laden den gespeicherten Inhalt wiederherstellen
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('textEditorContent');
            if (saved) {
                editor.innerHTML = saved;
            }
        });
        function loadRemoteFileIntoEditor(payload = {}) {
            if (typeof payload.content !== 'string') {
                return;
            }
            const isHtmlFile = typeof payload.isHtml === 'boolean'
                ? payload.isHtml
                : (payload.fileName ? /\.html?$/i.test(payload.fileName) : false);
            if (isHtmlFile) {
                editor.innerHTML = payload.content;
            } else {
                editor.innerText = payload.content;
            }
            currentRemoteFile = payload;
            const label = formatFileLabel(payload);
            updateDocumentTitle();
            setStatusPlain(label);
            localStorage.setItem('textEditorContent', editor.innerHTML);
            // Fokus nach dem Laden setzen, damit direkt getippt werden kann
            editor.focus();
        }
        window.addEventListener('message', (event) => {
            const data = event.data;
            if (!data || typeof data !== 'object') {
                return;
            }
            switch (data.type) {
                case 'textEditor:showLoading': {
                    const label = formatFileLabel(data.payload);
                    if (label) {
                        setStatusLocalized('textEditor.status.loadingWithLabel', { label });
                    } else {
                        setStatusLocalized('textEditor.status.loading');
                    }
                    break;
                }
                case 'textEditor:loadRemoteFile':
                    loadRemoteFileIntoEditor(data.payload);
                    break;
                case 'textEditor:loadError': {
                    const label = formatFileLabel(data.payload);
                    const message = data.payload && data.payload.message ? data.payload.message : appI18n.translate('textEditor.status.loadError');
                    if (label) {
                        setStatusPlain(`${label} — ${message}`);
                    } else {
                        setStatusPlain(message);
                    }
                    break;
                }
                default:
                    break;
            }
        });
        window.addEventListener('languagePreferenceChange', () => {
            updateDocumentTitle();
            applyStatusState();
        });
    </script>
</body>

</html>
