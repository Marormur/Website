{"version":3,"file":"preview-window-instance.js","sourceRoot":"","sources":["../src/ts/preview-window-instance.ts"],"names":[],"mappings":"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","sourcesContent":["import BaseWindowInstance, { BaseWindowConfig } from './base-window-instance';\r\n\r\n// Access global WindowChrome helper (no module export)\r\ntype WindowWithChrome = { WindowChrome?: {\r\n    createTitlebar: (cfg: {\r\n        title?: string; icon?: string; showClose?: boolean; showMinimize?: boolean; showMaximize?: boolean;\r\n        onClose?: () => void; onMinimize?: () => void; onMaximize?: () => void;\r\n    }) => HTMLElement;\r\n    createToolbar: (items: Array<{ type?: 'separator'; label?: string; icon?: string; title?: string; action?: string; onClick?: (e: MouseEvent) => void }>) => HTMLElement;\r\n    createStatusBar: (cfg: { leftContent?: string; rightContent?: string }) => HTMLElement;\r\n} };\r\nconst WindowChrome = (window as unknown as WindowWithChrome).WindowChrome!;\r\n\r\nexport interface PreviewWindowState {\r\n    imageUrl?: string;\r\n    repo?: string;\r\n    path?: string;\r\n    dimensions?: string;\r\n    size?: number;\r\n    zoom?: number;\r\n    images?: string[];\r\n    currentIndex?: number;\r\n}\r\n\r\nexport class PreviewWindowInstance extends BaseWindowInstance {\r\n    private keydownListener?: (e: KeyboardEvent) => void;\r\n    private _prevImages: string[] = [];\r\n\r\n    constructor(config: BaseWindowConfig) {\r\n        super(config);\r\n        // Base ctor initializes state; extend with preview defaults\r\n        this.updateState({\r\n            zoom: 1,\r\n            images: [],\r\n            currentIndex: 0,\r\n        });\r\n    }\r\n\r\n    render(): void {\r\n        if (!this.container) return;\r\n        this.container.innerHTML = '';\r\n        const titlebar = WindowChrome.createTitlebar({\r\n            title: this.title,\r\n            icon: './img/preview.png',\r\n            showClose: true,\r\n            showMinimize: true,\r\n            showMaximize: false,\r\n            onClose: () => this.destroy(),\r\n        });\r\n        this.container.appendChild(titlebar);\r\n\r\n        // Toolbar\r\n        const toolbar = WindowChrome.createToolbar([\r\n            { label: 'Zoom In', icon: 'ðŸ”+', onClick: () => this.zoomIn() },\r\n            { label: 'Zoom Out', icon: 'ðŸ”-', onClick: () => this.zoomOut() },\r\n            { type: 'separator' },\r\n            { label: 'Previous', icon: 'â¬…ï¸', onClick: () => this.prevImage() },\r\n            { label: 'Next', icon: 'âž¡ï¸', onClick: () => this.nextImage() },\r\n        ]);\r\n        this.container.appendChild(toolbar);\r\n\r\n        // Image area\r\n        const imageArea = document.createElement('div');\r\n        imageArea.className = 'preview-image-area flex justify-center items-center';\r\n        imageArea.style.height = 'calc(100% - 80px)';\r\n        imageArea.style.position = 'relative';\r\n        imageArea.ondrop = (e) => this.handleDrop(e);\r\n        imageArea.ondragover = (e) => e.preventDefault();\r\n\r\n        const st = this.getState() as unknown as PreviewWindowState;\r\n        const images = st.images || [];\r\n        const idx = st.currentIndex ?? 0;\r\n\r\n        // Revoke previous blob URLs that are no longer used\r\n        try {\r\n            const prev = this._prevImages || [];\r\n            const removed = prev.filter(p => p && p.startsWith('blob:') && !images.includes(p));\r\n            removed.forEach(u => {\r\n                try { URL.revokeObjectURL(u); } catch (e) {}\r\n            });\r\n        } catch (e) {}\r\n\r\n        if (images.length > 0 && images[idx]) {\r\n            const img = document.createElement('img');\r\n            img.src = images[idx];\r\n            img.style.maxWidth = '100%';\r\n            img.style.maxHeight = '100%';\r\n            img.style.transform = `scale(${st.zoom ?? 1})`;\r\n            img.style.display = 'block';\r\n            img.style.visibility = 'hidden';\r\n            img.draggable = true;\r\n            img.addEventListener('contextmenu', (e) => this.showContextMenu(e));\r\n            img.addEventListener('load', () => {\r\n                img.style.visibility = 'visible';\r\n                img.style.opacity = '1';\r\n            });\r\n            img.addEventListener('error', () => {\r\n                /* ignore image load errors for now */\r\n            });\r\n            imageArea.appendChild(img);\r\n        } else {\r\n            // Placeholder UI\r\n            const placeholder = document.createElement('div');\r\n            placeholder.className = 'text-gray-500 dark:text-gray-400 text-center px-6';\r\n            placeholder.textContent = 'No image selected';\r\n            imageArea.appendChild(placeholder);\r\n        }\r\n        this.container.appendChild(imageArea);\r\n\r\n        // Store images to allow revoking blob URLs on next render/destroy\r\n        this._prevImages = images.slice();\r\n\r\n        // Statusbar\r\n        const counter = images.length > 0 ? `${idx + 1} / ${images.length}` : '';\r\n        const statusBar = WindowChrome.createStatusBar({\r\n            leftContent: st.path || '',\r\n            rightContent: `Zoom: ${Math.round((st.zoom || 1) * 100)}% ${counter}`,\r\n        });\r\n        this.container.appendChild(statusBar);\r\n\r\n        // Keyboard shortcuts\r\n        this.attachKeyboardShortcuts();\r\n    }\r\n\r\n    attachKeyboardShortcuts() {\r\n        // Remove previous listener to avoid duplicates\r\n        if (this.keydownListener) {\r\n            document.removeEventListener('keydown', this.keydownListener);\r\n        }\r\n        this.keydownListener = (e: KeyboardEvent) => {\r\n            if (!this.isVisible) return;\r\n            if (e.key === 'ArrowLeft') {\r\n                e.preventDefault();\r\n                this.prevImage();\r\n            } else if (e.key === 'ArrowRight') {\r\n                e.preventDefault();\r\n                this.nextImage();\r\n            }\r\n        };\r\n        document.addEventListener('keydown', this.keydownListener);\r\n    }\r\n\r\n    zoomIn() {\r\n        const st = this.getState() as unknown as PreviewWindowState;\r\n        this.updateState({ zoom: Math.min((st.zoom || 1) + 0.1, 3) });\r\n        this.render();\r\n    }\r\n    zoomOut() {\r\n        const st = this.getState() as unknown as PreviewWindowState;\r\n        this.updateState({ zoom: Math.max((st.zoom || 1) - 0.1, 0.2) });\r\n        this.render();\r\n    }\r\n    nextImage() {\r\n        const st = this.getState() as unknown as PreviewWindowState;\r\n        const images = st.images || [];\r\n        if (images.length === 0) return;\r\n        const next = ((st.currentIndex ?? 0) + 1) % images.length;\r\n        this.updateState({ currentIndex: next });\r\n        this.render();\r\n    }\r\n    prevImage() {\r\n        const st = this.getState() as unknown as PreviewWindowState;\r\n        const images = st.images || [];\r\n        if (images.length === 0) return;\r\n        const prev = ((st.currentIndex ?? 0) - 1 + images.length) % images.length;\r\n        this.updateState({ currentIndex: prev });\r\n        this.render();\r\n    }\r\n    handleDrop(e: DragEvent) {\r\n        e.preventDefault();\r\n        const files = e.dataTransfer?.files;\r\n        if (files && files.length > 0 && files[0]) {\r\n            const url = URL.createObjectURL(files[0]);\r\n            this.updateState({ images: [url], currentIndex: 0 });\r\n            this.render();\r\n        }\r\n    }\r\n    showContextMenu(e: MouseEvent) {\r\n        e.preventDefault();\r\n        // TODO: Implement custom context menu (copy, save, open in new tab)\r\n    }\r\n    destroy() {\r\n        // Clean up keyboard listener before base destroy\r\n        if (this.keydownListener) {\r\n            document.removeEventListener('keydown', this.keydownListener);\r\n        }\r\n        // Revoke any remaining blob URLs we previously created\r\n        try {\r\n            (this._prevImages || []).forEach(u => {\r\n                if (u && u.startsWith('blob:')) {\r\n                    try { URL.revokeObjectURL(u); } catch (e) {}\r\n                }\r\n            });\r\n        } catch (e) {}\r\n\r\n        super.destroy();\r\n    }\r\n}\r\n\r\n// Attach to window (avoid any)\r\ntype WindowWithPreview = { PreviewWindowInstance?: typeof PreviewWindowInstance };\r\n(window as unknown as WindowWithPreview).PreviewWindowInstance = PreviewWindowInstance;\r\nexport default PreviewWindowInstance;\r\n"]}