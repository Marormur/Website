{"version":3,"file":"multi-instance-integration.js","sourceRoot":"","sources":["../src/ts/multi-instance-integration.ts"],"names":[],"mappings":";AAAA,uDAAuD;AACvD;;;;GAIG;AAEH,CAAC,GAAG,EAAE;IACF,YAAY,CAAC;IAqBb,MAAM,wBAAwB;QAA9B;YACY,iBAAY,GAAmC,IAAI,GAAG,EAAE,CAAC;YACzD,kBAAa,GAAG,KAAK,CAAC;QA0QlC,CAAC;QAxQG,IAAI;YACA,IAAI,IAAI,CAAC,aAAa;gBAAE,OAAO;YAC/B,IAAI,QAAQ,CAAC,UAAU,KAAK,SAAS,EAAE,CAAC;gBACpC,QAAQ,CAAC,gBAAgB,CAAC,kBAAkB,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC;YACtE,CAAC;iBAAM,CAAC;gBACJ,IAAI,CAAC,KAAK,EAAE,CAAC;YACjB,CAAC;QACL,CAAC;QAEO,KAAK;YACT,MAAM,CAAC,GAAG,MAAwC,CAAC;YACnD,IAAI,CAAC,CAAC,CAAC,eAAe,IAAI,CAAC,CAAC,CAAC,UAAU,IAAI,CAAC,CAAC,CAAC,iBAAiB,EAAE,CAAC;gBAC9D,OAAO,CAAC,KAAK,CAAC,4DAA4D,CAAC,CAAC;gBAC5E,OAAO;YACX,CAAC;YAED,IAAI,CAAC,CAAC,uBAAuB;gBAAE,IAAI,CAAC,wBAAwB,EAAE,CAAC;YAC/D,IAAI,CAAC,CAAC,yBAAyB;gBAAE,IAAI,CAAC,0BAA0B,EAAE,CAAC;YACnE,IAAI,CAAC,CAAC,qBAAqB;gBAAE,IAAI,CAAC,sBAAsB,EAAE,CAAC;YAE3D,IAAI,CAAC,CAAC,cAAc,EAAE,CAAC;gBACnB,IAAI,CAAC,CAAC,uBAAuB;oBACzB,CAAC,CAAC,cAAc,CAAC,eAAe,CAAC,UAAU,EAAE,CAAC,CAAC,uBAAuB,CAAC,CAAC;gBAC5E,IAAI,CAAC,CAAC,yBAAyB;oBAC3B,CAAC,CAAC,cAAc,CAAC,eAAe,CAAC,aAAa,EAAE,CAAC,CAAC,yBAAyB,CAAC,CAAC;gBACjF,IAAI,CAAC,CAAC,qBAAqB;oBACvB,CAAC,CAAC,cAAc,CAAC,eAAe,CAAC,QAAQ,EAAE,CAAC,CAAC,qBAAqB,CAAC,CAAC;gBAExE,CAAC,CAAC,cAAc,CAAC,kBAAkB,EAAE,CAAC;gBAEtC,0EAA0E;gBAC1E,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,WAAW,EAAE,IAAI,EAAE,EAAE;oBAC5C,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,GAAG,WAAW,CAAC;oBAC5C,uFAAuF;oBACvF,IAAI,CAAC;wBACD,MAAM,KAAK,GAAG,UAAiB,CAAC;wBAChC,MAAM,SAAS,GACX,OAAO,KAAK,EAAE,OAAO,KAAK,UAAU;4BAChC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC;4BAC3B,CAAC,CAAC,OAAO,KAAK,EAAE,UAAU,EAAE,OAAO,KAAK,UAAU;gCAChD,CAAC,CAAC,KAAK,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC;gCACjD,CAAC,CAAC,IAAI,CAAC;wBACjB,IAAI,SAAS;4BAAE,SAAS,EAAE,CAAC;oBAC/B,CAAC;oBAAC,MAAM,CAAC,CAAA,CAAC;oBACV,MAAM,MAAM,GAAG,OAAO,CAAC,iBAAiB,EAAE,CAAC;oBAC3C,IAAI,MAAM;wBAAE,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;gBAC3D,CAAC,CAAC,CAAC;gBAEH,CAAC,CAAC,cAAc,CAAC,aAAa,EAAE,CAAC;YACrC,CAAC;YAED,yCAAyC;YACzC,IACI,CAAC,CAAC,iBAAiB;gBACnB,OAAO,CAAC,CAAC,iBAAiB,CAAC,kBAAkB,KAAK,UAAU,EAC9D,CAAC;gBACC,CAAC,CAAC,iBAAiB,CAAC,kBAAkB,CAAC,GAAG,EAAE;oBACxC,IAAI,CAAC;wBACD,MAAM,EAAE,GAAG,CAAC,CAAC,aAAa,CAAC;wBAC3B,MAAM,GAAG,GACL,EAAE,IAAI,OAAO,EAAE,CAAC,YAAY,KAAK,UAAU,CAAC,CAAC,CAAC,EAAE,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;wBAC3E,MAAM,KAAK,GAAG,GAAG,EAAE,EAAE,IAAI,EAAE,CAAC;wBAC5B,IAAI,KAAK,GAAG,QAAQ,CAAC;wBACrB,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;4BACnC,IAAI,GAAG,IAAI,GAAG,CAAC,OAAO,KAAK,KAAK;gCAAE,KAAK,GAAG,GAAG,CAAC;wBAClD,CAAC,CAAC,CAAC;wBACH,OAAO,KAAK,CAAC;oBACjB,CAAC;oBAAC,MAAM,CAAC;wBACL,OAAO,QAAQ,CAAC;oBACpB,CAAC;gBACL,CAAC,CAAC,CAAC;YACP,CAAC;YAED,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;QAC9B,CAAC;QAEO,wBAAwB;YAC5B,MAAM,CAAC,GAAG,MAAwC,CAAC;YACnD,MAAM,OAAO,GAAG,CAAC,CAAC,uBAAkC,CAAC;YACrD,+CAA+C;YAC/C,MAAM,aAAa,GAAG,OAAO,CAAC,iBAAiB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC9D,OAAO,CAAC,iBAAiB,GAAG,CAAC,EAAU,EAAE,EAAE;gBACvC,aAAa,CAAC,EAAE,CAAC,CAAC;gBAClB,IAAI,CAAC,YAAY,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;YACtC,CAAC,CAAC;YACF,8DAA8D;YAC9D,MAAM,WAAW,GAAG,OAAO,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC1D,OAAO,CAAC,eAAe,GAAG,CAAC,EAAU,EAAE,EAAE;gBACrC,WAAW,CAAC,EAAE,CAAC,CAAC;gBAChB,MAAM,SAAS,GAAG,OAAO,CAAC,eAAe,EAAE,CAAC,MAAM,CAAC;gBACnD,IAAI,SAAS,GAAG,CAAC,EAAE,CAAC;oBAChB,MAAM,MAAM,GAAG,OAAO,CAAC,iBAAiB,EAAE,CAAC;oBAC3C,IAAI,MAAM;wBAAE,IAAI,CAAC,YAAY,CAAC,UAAU,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;gBACjE,CAAC;YACL,CAAC,CAAC;YAEF,MAAM,KAAK,GAAG,QAAQ,CAAC,cAAc,CAAC,yBAAyB,CAAC,CAAC;YACjE,IAAI,CAAC,KAAK;gBAAE,OAAO;YACnB,MAAM,UAAU,GAAG,CAAC,CAAC,UAAU,CAAC,MAAM,CAAC,OAAO,EAAE,KAAK,EAAE;gBACnD,SAAS,EAAE,IAAI;gBACf,qBAAqB,EAAE,GAAG,EAAE,CACxB,YAAY,CAAC,OAAO,CAAC,gBAAgB,EAAE,EAAE,IAAI,OAAO,CAAC,eAAe,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE;aAC3F,CAAC,CAAC;YAEH,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,UAAU,EAAE;gBAC9B,OAAO;gBACP,UAAU,EAAE,UAAU;gBACtB,OAAO,EAAE,gBAAgB;gBACzB,WAAW,EAAE,oBAAoB;aACpC,CAAC,CAAC;YAEH,IAAI,CAAC,wBAAwB,CAAC,UAAU,EAAE,OAAO,CAAC,CAAC;YACnD,0DAA0D;YAC1D,IAAI,CAAC,wBAAwB,CAAC,UAAU,CAAC,CAAC;YAC1C,oDAAoD;YACpD,IAAI,CAAC,sBAAsB,CAAC,UAAU,CAAC,CAAC;QAC5C,CAAC;QAEO,0BAA0B;YAC9B,MAAM,CAAC,GAAG,MAAwC,CAAC;YACnD,MAAM,OAAO,GAAG,CAAC,CAAC,yBAAoC,CAAC;YACvD,MAAM,aAAa,GAAG,OAAO,CAAC,iBAAiB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC9D,OAAO,CAAC,iBAAiB,GAAG,CAAC,EAAU,EAAE,EAAE;gBACvC,aAAa,CAAC,EAAE,CAAC,CAAC;gBAClB,IAAI,CAAC,YAAY,CAAC,aAAa,EAAE,EAAE,CAAC,CAAC;YACzC,CAAC,CAAC;YACF,MAAM,WAAW,GAAG,OAAO,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC1D,OAAO,CAAC,eAAe,GAAG,CAAC,EAAU,EAAE,EAAE;gBACrC,WAAW,CAAC,EAAE,CAAC,CAAC;gBAChB,MAAM,SAAS,GAAG,OAAO,CAAC,eAAe,EAAE,CAAC,MAAM,CAAC;gBACnD,IAAI,SAAS,GAAG,CAAC,EAAE,CAAC;oBAChB,MAAM,MAAM,GAAG,OAAO,CAAC,iBAAiB,EAAE,CAAC;oBAC3C,IAAI,MAAM;wBAAE,IAAI,CAAC,YAAY,CAAC,aAAa,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;gBACpE,CAAC;YACL,CAAC,CAAC;YAEF,MAAM,KAAK,GAAG,QAAQ,CAAC,cAAc,CAAC,4BAA4B,CAAC,CAAC;YACpE,IAAI,CAAC,KAAK;gBAAE,OAAO;YACnB,MAAM,UAAU,GAAG,CAAC,CAAC,UAAU,CAAC,MAAM,CAAC,OAAO,EAAE,KAAK,EAAE;gBACnD,SAAS,EAAE,IAAI;gBACf,qBAAqB,EAAE,GAAG,EAAE,CACxB,UAAU,CAAC,OAAO,CAAC,gBAAgB,EAAE,EAAE,IAAI,OAAO,CAAC,eAAe,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE;aACzF,CAAC,CAAC;YAEH,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,aAAa,EAAE;gBACjC,OAAO;gBACP,UAAU,EAAE,UAAU;gBACtB,OAAO,EAAE,YAAY;gBACrB,WAAW,EAAE,uBAAuB;aACvC,CAAC,CAAC;YAEH,IAAI,CAAC,wBAAwB,CAAC,aAAa,EAAE,OAAO,CAAC,CAAC;YACtD,IAAI,CAAC,wBAAwB,CAAC,aAAa,CAAC,CAAC;YAC7C,IAAI,CAAC,sBAAsB,CAAC,aAAa,CAAC,CAAC;QAC/C,CAAC;QAEO,sBAAsB;YAC1B,MAAM,CAAC,GAAG,MAAwC,CAAC;YACnD,MAAM,OAAO,GAAG,CAAC,CAAC,qBAAgC,CAAC;YACnD,MAAM,aAAa,GAAG,OAAO,CAAC,iBAAiB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC9D,OAAO,CAAC,iBAAiB,GAAG,CAAC,EAAU,EAAE,EAAE;gBACvC,aAAa,CAAC,EAAE,CAAC,CAAC;gBAClB,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;YACpC,CAAC,CAAC;YACF,MAAM,WAAW,GAAG,OAAO,CAAC,eAAe,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC1D,OAAO,CAAC,eAAe,GAAG,CAAC,EAAU,EAAE,EAAE;gBACrC,WAAW,CAAC,EAAE,CAAC,CAAC;gBAChB,MAAM,SAAS,GAAG,OAAO,CAAC,eAAe,EAAE,CAAC,MAAM,CAAC;gBACnD,IAAI,SAAS,KAAK,CAAC,EAAE,CAAC;oBAClB,IAAI,CAAC;wBACD,MAAM,GAAG,GAAI,MAAc,CAAC,GAAG,CAAC;wBAChC,IAAI,GAAG,EAAE,MAAM,EAAE,KAAK;4BAAE,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,cAAc,CAAC,CAAC;;4BACpD,QAAQ,CAAC,cAAc,CAAC,cAAc,CAAC,EAAE,SAAS,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;oBAC1E,CAAC;oBAAC,MAAM,CAAC,CAAA,CAAC;gBACd,CAAC;qBAAM,CAAC;oBACJ,MAAM,MAAM,GAAG,OAAO,CAAC,iBAAiB,EAAE,CAAC;oBAC3C,IAAI,MAAM;wBAAE,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;gBAC/D,CAAC;YACL,CAAC,CAAC;YAEF,MAAM,KAAK,GAAG,QAAQ,CAAC,cAAc,CAAC,uBAAuB,CAAC,CAAC;YAC/D,IAAI,CAAC,KAAK;gBAAE,OAAO;YACnB,MAAM,UAAU,GAAG,CAAC,CAAC,UAAU,CAAC,MAAM,CAAC,OAAO,EAAE,KAAK,EAAE;gBACnD,SAAS,EAAE,IAAI;gBACf,qBAAqB,EAAE,GAAG,EAAE,CACxB,UAAU,CAAC,OAAO,CAAC,gBAAgB,EAAE,EAAE,IAAI,OAAO,CAAC,eAAe,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE;aACzF,CAAC,CAAC;YAEH,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,QAAQ,EAAE;gBAC5B,OAAO;gBACP,UAAU,EAAE,UAAU;gBACtB,OAAO,EAAE,cAAc;gBACvB,WAAW,EAAE,kBAAkB;aAClC,CAAC,CAAC;YAEH,IAAI,CAAC,wBAAwB,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;YACjD,IAAI,CAAC,wBAAwB,CAAC,QAAQ,CAAC,CAAC;YACxC,IAAI,CAAC,sBAAsB,CAAC,QAAQ,CAAC,CAAC;QAC1C,CAAC;QAEO,sBAAsB,CAAC,IAAY;YACvC,MAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YAChD,IAAI,CAAC,WAAW;gBAAE,OAAO;YACzB,MAAM,EAAE,OAAO,EAAE,GAAG,WAAW,CAAC;YAEhC,MAAM,cAAc,GAAG,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAC5D,OAAO,CAAC,cAAc,GAAG,CAAC,MAA2B,EAAE,EAAE;gBACrD,MAAM,QAAQ,GAAG,cAAc,CAAC,MAAM,CAAC,CAAC;gBACxC,0EAA0E;gBAC1E,MAAM,MAAM,GAAG,OAAO,CAAC,iBAAiB,EAAE,CAAC;gBAC3C,IAAI,MAAM,EAAE,CAAC;oBACT,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;gBAC/C,CAAC;qBAAM,IAAI,QAAQ,EAAE,CAAC;oBAClB,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,QAAQ,CAAC,UAAU,CAAC,CAAC;gBACjD,CAAC;gBACD,OAAO,QAAQ,CAAC;YACpB,CAAC,CAAC;QACN,CAAC;QAED,YAAY,CAAC,IAAY,EAAE,UAAkB;YACzC,MAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YAChD,IAAI,CAAC,WAAW;gBAAE,OAAO;YACzB,MAAM,SAAS,GAAG,WAAW,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC;YACxD,SAAS,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;gBACrB,IAAI,IAAI,CAAC,UAAU,KAAK,UAAU;oBAAE,IAAI,CAAC,IAAI,EAAE,EAAE,CAAC;;oBAC7C,IAAI,CAAC,IAAI,EAAE,EAAE,CAAC;YACvB,CAAC,CAAC,CAAC;QACP,CAAC;QAED,wBAAwB,CAAC,IAAY;YACjC,MAAM,WAAW,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YAChD,IAAI,CAAC,WAAW;gBAAE,OAAO;YACzB,MAAM,MAAM,GAAG,WAAW,CAAC,OAAO,CAAC,iBAAiB,EAAE,CAAC;YACvD,IAAI,MAAM,EAAE,CAAC;gBACT,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,MAAM,CAAC,UAAU,CAAC,CAAC;YAC/C,CAAC;iBAAM,CAAC;gBACJ,MAAM,GAAG,GAAG,WAAW,CAAC,OAAO,CAAC,eAAe,EAAE,CAAC;gBAClD,IAAI,GAAG,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBACjB,MAAM,KAAK,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC;oBACrB,IAAI,KAAK,EAAE,CAAC;wBACR,MAAM,OAAO,GAAG,KAAK,CAAC,UAAU,CAAC;wBACjC,uCAAuC;wBACvC,WAAW,CAAC,OAAO,CAAC,iBAAiB,CAAC,OAAO,CAAC,CAAC;wBAC/C,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;oBACrC,CAAC;gBACL,CAAC;YACL,CAAC;QACL,CAAC;QAEO,wBAAwB,CAAC,IAAY,EAAE,OAAgB;YAC3D,MAAM,CAAC,GAAG,MAAwC,CAAC;YACnD,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,OAAO,CAAC;YACrD,MAAM,OAAO,GAAG,OAAO,CAAC,CAAC,CAAC,QAAQ,CAAC,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;YAClE,IAAI,CAAC,OAAO,EAAE,CAAC;gBACX,OAAO,CAAC,KAAK,CAAC,iCAAiC,IAAI,WAAW,OAAO,YAAY,CAAC,CAAC;gBACnF,OAAO;YACX,CAAC;YACD,MAAM,UAAU,GAAG,CAAC,CAAC,iBAAiB,CAAC,QAAQ,CAAC,OAAO,EAAE;gBACrD,KAAK,EAAE,QAAQ;gBACf,eAAe,EAAE,GAAG,EAAE,CAAC,GAAG,IAAI,IAAI,OAAO,CAAC,gBAAgB,EAAE,GAAG,CAAC,EAAE;aACrE,CAAC,CAAC;YACH,MAAM,GAAG,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC;YACxC,IAAI,GAAG;gBAAE,GAAG,CAAC,mBAAmB,GAAG,UAAU,CAAC;QAClD,CAAC;KACJ;IAED,oEAAoE;IACpE,MAAM,WAAW,GAAG,IAAI,wBAAwB,EAAE,CAAC;IAClD,MAAc,CAAC,wBAAwB,GAAG,WAAW,CAAC;IACtD,MAAc,CAAC,wBAAwB,GAAG,WAAW,CAAC;IACvD,WAAW,CAAC,IAAI,EAAE,CAAC;AACvB,CAAC,CAAC,EAAE,CAAC","sourcesContent":["/* eslint-disable @typescript-eslint/no-explicit-any */\n/**\n * Multi-Instance Modal Integration (TypeScript)\n * Integrates the tab system with existing modals (Terminal, TextEditor, Finder)\n * Wires up keyboard shortcuts and session management\n */\n\n(() => {\n    'use strict';\n\n    type Instance = { instanceId: string; show?: () => void; hide?: () => void };\n    type Manager = {\n        getAllInstances(): Instance[];\n        getActiveInstance(): Instance | null;\n        getAllInstanceIds?: () => string[];\n        getInstanceCount: () => number;\n        setActiveInstance(id: string): void;\n        createInstance(cfg?: { title?: string }): Instance | null;\n        destroyInstance(id: string): void;\n    };\n\n    type IntegrationRecord = {\n        manager: Manager;\n        tabManager: unknown;\n        modalId: string;\n        containerId: string;\n        unregisterShortcuts?: () => void;\n    };\n\n    class MultiInstanceIntegration {\n        private integrations: Map<string, IntegrationRecord> = new Map();\n        private isInitialized = false;\n\n        init() {\n            if (this.isInitialized) return;\n            if (document.readyState === 'loading') {\n                document.addEventListener('DOMContentLoaded', () => this.setup());\n            } else {\n                this.setup();\n            }\n        }\n\n        private setup() {\n            const W = window as unknown as Record<string, any>;\n            if (!W.InstanceManager || !W.WindowTabs || !W.KeyboardShortcuts) {\n                console.error('MultiInstanceIntegration: Required dependencies not loaded');\n                return;\n            }\n\n            if (W.TerminalInstanceManager) this.setupTerminalIntegration();\n            if (W.TextEditorInstanceManager) this.setupTextEditorIntegration();\n            if (W.FinderInstanceManager) this.setupFinderIntegration();\n\n            if (W.SessionManager) {\n                if (W.TerminalInstanceManager)\n                    W.SessionManager.registerManager('terminal', W.TerminalInstanceManager);\n                if (W.TextEditorInstanceManager)\n                    W.SessionManager.registerManager('text-editor', W.TextEditorInstanceManager);\n                if (W.FinderInstanceManager)\n                    W.SessionManager.registerManager('finder', W.FinderInstanceManager);\n\n                W.SessionManager.restoreAllSessions();\n\n                // Ensure tabs/controllers reflect restored state and show active instance\n                this.integrations.forEach((integration, type) => {\n                    const { manager, tabManager } = integration;\n                    // Support both legacy adapter ({controller: {refresh}}) and new controller ({refresh})\n                    try {\n                        const maybe = tabManager as any;\n                        const refreshFn =\n                            typeof maybe?.refresh === 'function'\n                                ? maybe.refresh.bind(maybe)\n                                : typeof maybe?.controller?.refresh === 'function'\n                                  ? maybe.controller.refresh.bind(maybe.controller)\n                                  : null;\n                        if (refreshFn) refreshFn();\n                    } catch {}\n                    const active = manager.getActiveInstance();\n                    if (active) this.showInstance(type, active.instanceId);\n                });\n\n                W.SessionManager.startAutoSave();\n            }\n\n            // Scope keyboard shortcuts by top window\n            if (\n                W.KeyboardShortcuts &&\n                typeof W.KeyboardShortcuts.setContextResolver === 'function'\n            ) {\n                W.KeyboardShortcuts.setContextResolver(() => {\n                    try {\n                        const wm = W.WindowManager;\n                        const top =\n                            wm && typeof wm.getTopWindow === 'function' ? wm.getTopWindow() : null;\n                        const topId = top?.id || '';\n                        let match = 'global';\n                        this.integrations.forEach((val, key) => {\n                            if (val && val.modalId === topId) match = key;\n                        });\n                        return match;\n                    } catch {\n                        return 'global';\n                    }\n                });\n            }\n\n            this.isInitialized = true;\n        }\n\n        private setupTerminalIntegration() {\n            const W = window as unknown as Record<string, any>;\n            const manager = W.TerminalInstanceManager as Manager;\n            // Hook active switch to also update visibility\n            const origSetActive = manager.setActiveInstance.bind(manager);\n            manager.setActiveInstance = (id: string) => {\n                origSetActive(id);\n                this.showInstance('terminal', id);\n            };\n            // Hook destroy to ensure visibility and state stay consistent\n            const origDestroy = manager.destroyInstance.bind(manager);\n            manager.destroyInstance = (id: string) => {\n                origDestroy(id);\n                const remaining = manager.getAllInstances().length;\n                if (remaining > 0) {\n                    const active = manager.getActiveInstance();\n                    if (active) this.showInstance('terminal', active.instanceId);\n                }\n            };\n\n            const mount = document.getElementById('terminal-tabs-container');\n            if (!mount) return;\n            const controller = W.WindowTabs.create(manager, mount, {\n                addButton: true,\n                onCreateInstanceTitle: () =>\n                    `Terminal ${(manager.getInstanceCount?.() || manager.getAllInstances().length) + 1}`,\n            });\n\n            this.integrations.set('terminal', {\n                manager,\n                tabManager: controller,\n                modalId: 'terminal-modal',\n                containerId: 'terminal-container',\n            });\n\n            this.registerShortcutsForType('terminal', manager);\n            // Ensure the current active instance is visible in the UI\n            this.updateInstanceVisibility('terminal');\n            // Ensure visibility after future instance creations\n            this.setupInstanceListeners('terminal');\n        }\n\n        private setupTextEditorIntegration() {\n            const W = window as unknown as Record<string, any>;\n            const manager = W.TextEditorInstanceManager as Manager;\n            const origSetActive = manager.setActiveInstance.bind(manager);\n            manager.setActiveInstance = (id: string) => {\n                origSetActive(id);\n                this.showInstance('text-editor', id);\n            };\n            const origDestroy = manager.destroyInstance.bind(manager);\n            manager.destroyInstance = (id: string) => {\n                origDestroy(id);\n                const remaining = manager.getAllInstances().length;\n                if (remaining > 0) {\n                    const active = manager.getActiveInstance();\n                    if (active) this.showInstance('text-editor', active.instanceId);\n                }\n            };\n\n            const mount = document.getElementById('text-editor-tabs-container');\n            if (!mount) return;\n            const controller = W.WindowTabs.create(manager, mount, {\n                addButton: true,\n                onCreateInstanceTitle: () =>\n                    `Editor ${(manager.getInstanceCount?.() || manager.getAllInstances().length) + 1}`,\n            });\n\n            this.integrations.set('text-editor', {\n                manager,\n                tabManager: controller,\n                modalId: 'text-modal',\n                containerId: 'text-editor-container',\n            });\n\n            this.registerShortcutsForType('text-editor', manager);\n            this.updateInstanceVisibility('text-editor');\n            this.setupInstanceListeners('text-editor');\n        }\n\n        private setupFinderIntegration() {\n            const W = window as unknown as Record<string, any>;\n            const manager = W.FinderInstanceManager as Manager;\n            const origSetActive = manager.setActiveInstance.bind(manager);\n            manager.setActiveInstance = (id: string) => {\n                origSetActive(id);\n                this.showInstance('finder', id);\n            };\n            const origDestroy = manager.destroyInstance.bind(manager);\n            manager.destroyInstance = (id: string) => {\n                origDestroy(id);\n                const remaining = manager.getAllInstances().length;\n                if (remaining === 0) {\n                    try {\n                        const API = (window as any).API;\n                        if (API?.window?.close) API.window.close('finder-modal');\n                        else document.getElementById('finder-modal')?.classList.add('hidden');\n                    } catch {}\n                } else {\n                    const active = manager.getActiveInstance();\n                    if (active) this.showInstance('finder', active.instanceId);\n                }\n            };\n\n            const mount = document.getElementById('finder-tabs-container');\n            if (!mount) return;\n            const controller = W.WindowTabs.create(manager, mount, {\n                addButton: true,\n                onCreateInstanceTitle: () =>\n                    `Finder ${(manager.getInstanceCount?.() || manager.getAllInstances().length) + 1}`,\n            });\n\n            this.integrations.set('finder', {\n                manager,\n                tabManager: controller,\n                modalId: 'finder-modal',\n                containerId: 'finder-container',\n            });\n\n            this.registerShortcutsForType('finder', manager);\n            this.updateInstanceVisibility('finder');\n            this.setupInstanceListeners('finder');\n        }\n\n        private setupInstanceListeners(type: string) {\n            const integration = this.integrations.get(type);\n            if (!integration) return;\n            const { manager } = integration;\n\n            const originalCreate = manager.createInstance.bind(manager);\n            manager.createInstance = (config?: { title?: string }) => {\n                const instance = originalCreate(config);\n                // After create, prefer showing the active; otherwise show the created one\n                const active = manager.getActiveInstance();\n                if (active) {\n                    this.showInstance(type, active.instanceId);\n                } else if (instance) {\n                    this.showInstance(type, instance.instanceId);\n                }\n                return instance;\n            };\n        }\n\n        showInstance(type: string, instanceId: string) {\n            const integration = this.integrations.get(type);\n            if (!integration) return;\n            const instances = integration.manager.getAllInstances();\n            instances.forEach(inst => {\n                if (inst.instanceId === instanceId) inst.show?.();\n                else inst.hide?.();\n            });\n        }\n\n        updateInstanceVisibility(type: string) {\n            const integration = this.integrations.get(type);\n            if (!integration) return;\n            const active = integration.manager.getActiveInstance();\n            if (active) {\n                this.showInstance(type, active.instanceId);\n            } else {\n                const all = integration.manager.getAllInstances();\n                if (all.length > 0) {\n                    const first = all[0];\n                    if (first) {\n                        const firstId = first.instanceId;\n                        // Ensure a consistent active selection\n                        integration.manager.setActiveInstance(firstId);\n                        this.showInstance(type, firstId);\n                    }\n                }\n            }\n        }\n\n        private registerShortcutsForType(type: string, manager: Manager) {\n            const W = window as unknown as Record<string, any>;\n            const modalId = this.integrations.get(type)?.modalId;\n            const modalEl = modalId ? document.getElementById(modalId) : null;\n            if (!modalEl) {\n                console.error(`Cannot register shortcuts for ${type}: modal ${modalId} not found`);\n                return;\n            }\n            const unregister = W.KeyboardShortcuts.register(manager, {\n                scope: document,\n                newTitleFactory: () => `${type} ${manager.getInstanceCount() + 1}`,\n            });\n            const rec = this.integrations.get(type);\n            if (rec) rec.unregisterShortcuts = unregister;\n        }\n    }\n\n    // Create and expose singleton (retain both names for compatibility)\n    const integration = new MultiInstanceIntegration();\n    (window as any).MultiInstanceIntegration = integration;\n    (window as any).multiInstanceIntegration = integration;\n    integration.init();\n})();\n\n"]}