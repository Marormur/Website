<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Marvin</title>
        <link rel="icon" href="./img/sucher.png" />
        <link rel="stylesheet" href="./dist/output.css" />
        <link rel="stylesheet" href="./src/css/style.css" />

        <!-- Early readiness monitor: mark __APP_READY only after core globals appear, with a hard
             fallback after a generous timeout to keep tests unblocked. -->
        <script>
            (() => {
                const w = window;
                w.__APP_READY = false;
                const hasCore = () => !!(w.ActionBus && w.WindowRegistry && w.DockSystem);
                const markReady = label => {
                    if (!w.__APP_READY) {
                        console.info(`[AppReady Monitor] ready via ${label}`);
                        w.__APP_READY = true;
                    }
                };

                // Poll until core is present, then mark ready
                let polls = 0;
                const poll = () => {
                    if (hasCore()) {
                        markReady('core-present');
                        return;
                    }
                    polls += 1;
                    if (polls < 60) {
                        setTimeout(poll, 200);
                    }
                };
                poll();

                // Safety timeout: if core never appears, unblock tests after 12s
                setTimeout(() => markReady('timeout-12s'), 12000);
            })();
        </script>

        <!-- üîÄ Conditional Module Loading (October 28, 2025) -->
        <!-- Controls whether to load esbuild bundle OR individual scripts -->
        <script>
            // USE_BUNDLE flag: Controls module loading strategy
            // Sources (priority order):
            // 1) Env-injected (tests): window.__USE_BUNDLE__ = true/false
            // 2) URL param: ?bundle=1 or ?bundle=0
            // 3) localStorage: USE_BUNDLE = '1' or '0'
            // Default (fallback): true (Bundle as default)

            const urlParams = new URLSearchParams(window.location.search);
            const urlBundleParam = urlParams.get('bundle');
            const bundleFromUrl =
                urlBundleParam === '1' ? true : urlBundleParam === '0' ? false : undefined;

            const storageFlag = window.localStorage.getItem('USE_BUNDLE');
            const bundleFromStorage =
                storageFlag === '1' ? true : storageFlag === '0' ? false : undefined;

            const bundleFromEnv =
                typeof window.__USE_BUNDLE__ !== 'undefined' ? !!window.__USE_BUNDLE__ : undefined;

            const defaultBundle = true; // Bundle default (all modules now included)
            // Pick first defined source, otherwise use default
            window.USE_BUNDLE = [
                bundleFromEnv,
                bundleFromUrl,
                bundleFromStorage,
                defaultBundle,
            ].find(v => v !== undefined);

            console.log('[Module Loader] USE_BUNDLE:', window.USE_BUNDLE);
        </script>

        <script>
            // Conditional loading: Either bundle OR individual scripts (sequential, no document.write)
            (() => {
                const legacyScripts = [
                    './js/core/logger.js',
                    './js/core/error-handler.js',
                    './js/core/perf-monitor.js',
                    './js/core/constants.js',
                    './js/ui/icons.js',
                    './js/services/theme.js',
                    './js/ui/dock.js',
                    './js/services/storage.js',
                    './js/ui/snap-utils.js',
                    './js/ui/dialog-utils.js',
                    './js/ui/dialog.js',
                    './js/ui/desktop.js',
                    './js/services/system.js',
                    './js/ui/menubar-utils.js',
                    './js/services/program-actions.js',
                    './js/ui/menu.js',
                    './js/services/github-api.js',
                    './js/apps/finder/finder.js',
                    './js/apps/finder/finder-window.js',
                    './js/windows/window-manager.js',
                    './js/ui/action-bus.js',
                    './js/windows/window-configs.js',
                    './js/core/api.js',
                    './js/windows/base-window-instance.js',
                    './js/windows/instance-manager.js',
                    './js/windows/window-chrome.js',
                    './js/windows/window-tabs.js',
                    './js/ui/keyboard-shortcuts.js',
                    './js/services/session-manager.js',
                    './js/windows/multi-instance-integration.js',
                    './js/ui/context-menu.js',
                    './js/services/settings.js',
                    './js/apps/text-editor/text-editor.js',
                    './js/apps/text-editor/text-editor-instance.js',
                    './js/apps/terminal/terminal.js',
                    './js/apps/terminal/terminal-instance.js',
                    './js/apps/photos/photos-app.js',
                    './js/apps/finder/finder-instance.js',
                    './js/ui/launchpad.js',
                    './js/apps/photos/image-viewer-utils.js',
                    './js/services/program-menu-sync.js',
                    './js/core/app-init.js',
                    './app.js',
                ];

                // Expose list for fallback reuse
                window.__LEGACY_SCRIPTS__ = legacyScripts;

                const appended = new Set();
                const normalize = src => new URL(src, document.baseURI).href;
                const isAlreadyAdded = src => {
                    const full = normalize(src);
                    if (appended.has(full)) return true;
                    return !!document.querySelector(
                        `script[src="${full}"]` + `,script[src="${src}"]`
                    );
                };

                const appendScriptOnce = (src, attrs = {}, label = 'loader') =>
                    new Promise((resolve, reject) => {
                        const full = normalize(src);
                        if (isAlreadyAdded(src)) {
                            appended.add(full);
                            resolve();
                            return;
                        }

                        const s = document.createElement('script');
                        s.src = src;
                        s.async = false; // keep execution order deterministic
                        Object.entries(attrs || {}).forEach(([k, v]) => {
                            s.setAttribute(k, String(v));
                        });
                        s.onload = () => {
                            appended.add(full);
                            resolve();
                        };
                        s.onerror = err => {
                            appended.add(full);
                            console.error(`[Module Loader] Failed to load ${src}`, err);
                            reject(err);
                        };
                        s.dataset.loader = label;
                        document.head.appendChild(s);
                    });

                const loadSequential = async (list, label = 'legacy') => {
                    for (const src of list) {
                        try {
                            await appendScriptOnce(src, {}, label);
                        } catch (err) {
                            // Continue loading remaining scripts even if one fails
                            console.warn(`[Module Loader] Continuing after error for ${src}`);
                        }
                    }
                };

                window.__SCRIPT_LOADER__ = {
                    appendScriptOnce,
                    loadSequential,
                    legacyScripts,
                };

                const start = async () => {
                    if (window.USE_BUNDLE) {
                        console.log('[Module Loader] Loading esbuild bundle (includes i18n)...');
                        await appendScriptOnce('./js/app.bundle.js', {}, 'bundle');
                    } else {
                        console.log('[Module Loader] Loading individual scripts...');
                        await loadSequential(legacyScripts, 'legacy');
                    }
                };

                // Expose promise for potential dependents
                window.__MODULE_LOADER_PROMISE__ = start().catch(err => {
                    console.error('[Module Loader] Fatal error during loading', err);
                });
            })();
        </script>

        <!-- Resilient loader fallback: if neither bundle nor legacy scripts register core globals
             within a short grace period, attempt to load the bundle again; if still absent, load
             the legacy script list sequentially. This avoids blank/mostly-static pages when the
             document.write path is bypassed (e.g., due to prerendering or CSP in some runners). -->
        <script>
            (() => {
                const hasCore = () =>
                    !!(window.ActionBus && window.WindowRegistry && window.DockSystem);

                const appendScriptOnce =
                    window.__SCRIPT_LOADER__?.appendScriptOnce ||
                    ((src, attrs = {}, label = 'fallback') => {
                        const s = document.createElement('script');
                        s.src = src;
                        s.async = false;
                        Object.entries(attrs || {}).forEach(([k, v]) => s.setAttribute(k, v));
                        s.dataset.loader = label;
                        document.head.appendChild(s);
                        return new Promise(resolve => {
                            const done = () => resolve();
                            s.onload = done;
                            s.onerror = done;
                        });
                    });

                const loadBundleOnce = () => {
                    if (document.querySelector('script[data-fallback-bundle]')) return;
                    appendScriptOnce(
                        './js/app.bundle.js',
                        { 'data-fallback-bundle': '1' },
                        'fallback-bundle'
                    ).catch(err =>
                        console.warn('[Module Loader Fallback] bundle load failed', err)
                    );
                };

                const legacyScripts = window.__LEGACY_SCRIPTS__ || [
                    './js/core/logger.js',
                    './js/core/error-handler.js',
                    './js/core/perf-monitor.js',
                    './js/core/constants.js',
                    './js/ui/icons.js',
                    './js/services/theme.js',
                    './js/ui/dock.js',
                    './js/services/storage.js',
                    './js/ui/snap-utils.js',
                    './js/ui/dialog-utils.js',
                    './js/ui/dialog.js',
                    './js/ui/desktop.js',
                    './js/services/system.js',
                    './js/ui/menubar-utils.js',
                    './js/services/program-actions.js',
                    './js/ui/menu.js',
                    './js/services/github-api.js',
                    './js/apps/finder/finder.js',
                    './js/apps/finder/finder-window.js',
                    './js/windows/window-manager.js',
                    './js/ui/action-bus.js',
                    './js/windows/window-configs.js',
                    './js/core/api.js',
                    './js/windows/base-window-instance.js',
                    './js/windows/instance-manager.js',
                    './js/windows/window-chrome.js',
                    './js/windows/window-tabs.js',
                    './js/ui/keyboard-shortcuts.js',
                    './js/services/session-manager.js',
                    './js/windows/multi-instance-integration.js',
                    './js/ui/context-menu.js',
                    './js/services/settings.js',
                    './js/apps/text-editor/text-editor.js',
                    './js/apps/text-editor/text-editor-instance.js',
                    './js/apps/terminal/terminal.js',
                    './js/apps/terminal/terminal-instance.js',
                    './js/apps/photos/photos-app.js',
                    './js/apps/finder/finder-instance.js',
                    './js/ui/launchpad.js',
                    './js/apps/photos/image-viewer-utils.js',
                    './js/services/program-menu-sync.js',
                    './js/core/app-init.js',
                    './app.js',
                ];

                let legacyLoading = false;
                const loadLegacySequential = () => {
                    if (legacyLoading) return;
                    legacyLoading = true;
                    const loader = window.__SCRIPT_LOADER__?.loadSequential;
                    if (loader) {
                        loader(legacyScripts, 'fallback-legacy');
                        return;
                    }
                    const loadAt = idx => {
                        if (idx >= legacyScripts.length) return;
                        const s = document.createElement('script');
                        s.src = legacyScripts[idx];
                        s.onload = () => loadAt(idx + 1);
                        s.onerror = () => loadAt(idx + 1);
                        s.async = false;
                        s.dataset.loader = 'fallback-legacy';
                        document.head.appendChild(s);
                    };
                    loadAt(0);
                };

                const ensureLoaded = label => {
                    if (hasCore()) return;
                    console.warn(`[Module Loader Fallback] missing core after ${label}, retrying`);
                    loadBundleOnce();
                    setTimeout(() => {
                        if (!hasCore()) {
                            console.warn(
                                '[Module Loader Fallback] bundle retry failed; loading legacy scripts'
                            );
                            loadLegacySequential();
                        }
                    }, 500);
                };

                // Staggered checks to survive slow environments
                [600, 1500, 3000].forEach(delay =>
                    setTimeout(() => ensureLoaded(`t+${delay}ms`), delay)
                );
            })();
        </script>
    </head>

    <body class="m-0 text-gray-900 dark:text-gray-100 transition-colors duration-300">
        <!-- macOS Menubar -->
        <header class="menubar">
            <div class="menubar-left">
                <div id="apple-menu-container" class="menubar-trigger">
                    <button
                        id="apple-menu-trigger"
                        type="button"
                        class="menubar-logo"
                        aria-label="Apple-Men√º"
                        aria-haspopup="menu"
                        aria-expanded="false"
                        aria-controls="apple-menu-dropdown"
                        data-menubar-trigger-button="true"
                    >
                        üë®üèº‚Äçüíª
                    </button>
                    <ul
                        id="apple-menu-dropdown"
                        class="menu-dropdown hidden"
                        role="menu"
                        aria-labelledby="apple-menu-trigger"
                    >
                        <li role="none">
                            <button
                                type="button"
                                role="menuitem"
                                id="dropdown-about"
                                class="menu-item"
                                tabindex="-1"
                                data-action="openAbout"
                                data-i18n="header.profile.about"
                            >
                                √úber Marvin
                            </button>
                        </li>
                        <li class="menu-separator" role="separator" aria-hidden="true"></li>
                        <li role="none">
                            <button
                                type="button"
                                role="menuitem"
                                id="dropdown-reset-layout"
                                class="menu-item"
                                tabindex="-1"
                                data-action="resetWindowLayout"
                                data-i18n="header.profile.resetLayout"
                            >
                                Fenster zur√ºcksetzen
                            </button>
                        </li>
                        <li role="none">
                            <button
                                type="button"
                                role="menuitem"
                                id="dropdown-settings"
                                class="menu-item"
                                tabindex="-1"
                                data-action="openSettings"
                                data-i18n="header.profile.settings"
                            >
                                Systemeinstellungen
                            </button>
                        </li>
                        <li class="menu-separator" role="separator" aria-hidden="true"></li>
                        <!-- API Docs Link entfernt: JSDoc wurde aus dem Build entfernt -->
                        <li role="none">
                            <a
                                href="https://www.linkedin.com/in/marvin-temmen-788537216"
                                rel="noopener noreferrer"
                                target="_blank"
                                class="menu-item menu-item-link"
                                role="menuitem"
                                tabindex="-1"
                                data-i18n="header.profile.linkedin"
                                >LinkedIn</a
                            >
                        </li>
                    </ul>
                </div>
                <div id="program-menu-container" class="menubar-trigger">
                    <button
                        id="program-label"
                        type="button"
                        class="menubar-item menubar-app no-select"
                        data-i18n="programs.default.label"
                        aria-haspopup="menu"
                        aria-expanded="false"
                        aria-controls="program-dropdown"
                        data-menubar-trigger-button="true"
                    >
                        Sucher
                    </button>
                    <ul
                        id="program-dropdown"
                        class="menu-dropdown hidden"
                        role="menu"
                        aria-labelledby="program-label"
                    >
                        <li role="none">
                            <button
                                type="button"
                                role="menuitem"
                                id="about-program"
                                class="menu-item"
                                tabindex="-1"
                                data-action="openProgramInfo"
                                data-i18n="programs.default.infoLabel"
                            >
                                √úber Sucher
                            </button>
                        </li>
                        <li class="menu-separator" role="separator" aria-hidden="true"></li>
                        <li role="none">
                            <button
                                type="button"
                                role="menuitem"
                                id="program-close-current"
                                class="menu-item"
                                tabindex="-1"
                                data-action="closeTopWindow"
                                data-i18n="header.program.close"
                            >
                                Programm schlie√üen
                            </button>
                        </li>
                    </ul>
                </div>
                <!-- Window Menu (dynamically populated by TypeScript) -->
                <div id="window-menu-container" class="menubar-trigger" style="display: none">
                    <button
                        id="window-menu-trigger"
                        type="button"
                        class="menubar-item no-select"
                        data-i18n="menubar.window.label"
                        aria-haspopup="menu"
                        aria-expanded="false"
                        aria-controls="window-menu-dropdown"
                        data-menubar-trigger-button="true"
                    >
                        Fenster
                    </button>
                    <ul
                        id="window-menu-dropdown"
                        class="menu-dropdown hidden"
                        role="menu"
                        aria-labelledby="window-menu-trigger"
                    >
                        <!-- Dynamically populated by window-menu.ts -->
                    </ul>
                </div>
                <nav
                    id="menubar-links"
                    class="menubar-links"
                    role="menubar"
                    aria-label="Anwendungsmen√ºs"
                    data-i18n-aria-label="menubar.applicationMenus"
                ></nav>
            </div>
            <div class="menubar-right">
                <div class="menubar-status-cluster">
                    <div class="menubar-trigger menubar-status-trigger">
                        <button
                            id="wifi-status-trigger"
                            type="button"
                            class="menubar-status-icon"
                            aria-label="WLAN Status"
                            data-i18n-aria-label="menubar.toggles.wifiStatus"
                            aria-haspopup="menu"
                            aria-expanded="false"
                            aria-controls="wifi-menu"
                            data-system-menu-trigger="wifi"
                        >
                            <span class="menubar-status-icon-svg" data-icon="wifi"></span>
                        </button>
                        <div
                            id="wifi-menu"
                            class="menu-dropdown menu-right hidden system-dropdown"
                            aria-labelledby="wifi-status-trigger"
                        >
                            <div class="system-section" role="presentation">
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    aria-pressed="true"
                                    data-system-action="toggle-wifi"
                                >
                                    <span class="menu-item-label" data-i18n="menubar.toggles.wifi"
                                        >WLAN</span
                                    >
                                    <span class="system-state-pill" data-state="wifi"></span>
                                </button>
                            </div>
                            <div class="system-section" role="presentation">
                                <p
                                    class="system-section-title"
                                    data-i18n="menubar.wifi.preferredNetworks"
                                >
                                    Bevorzugte Netzwerke
                                </p>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-network="HomeLAN"
                                    aria-pressed="true"
                                >
                                    <span class="menu-item-label" data-i18n="menubar.networks.home"
                                        >HomeLAN</span
                                    >
                                    <span
                                        class="system-network-indicator"
                                        data-i18n="menubar.state.connected"
                                        >Verbunden</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-network="Office"
                                    aria-pressed="false"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.networks.office"
                                        >Office</span
                                    >
                                    <span
                                        class="system-network-indicator"
                                        data-i18n="menubar.state.automatic"
                                        >Automatisch</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-network="Hotspot"
                                    aria-pressed="false"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.networks.hotspot"
                                        >Marvin iPhone</span
                                    >
                                    <span
                                        class="system-network-indicator"
                                        data-i18n="menubar.state.hotspot"
                                        >Pers√∂nlicher Hotspot</span
                                    >
                                </button>
                            </div>
                            <div class="system-section" role="presentation">
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-system-action="open-network"
                                    data-i18n-aria-label="menubar.actions.networkSettings"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.actions.networkSettings"
                                        >Netzwerkeinstellungen ‚Ä¶</span
                                    >
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="menubar-trigger menubar-status-trigger">
                        <button
                            id="bluetooth-status-trigger"
                            type="button"
                            class="menubar-status-icon"
                            aria-label="Bluetooth Status"
                            data-i18n-aria-label="menubar.toggles.bluetoothStatus"
                            aria-haspopup="menu"
                            aria-expanded="false"
                            aria-controls="bluetooth-menu"
                            data-system-menu-trigger="bluetooth"
                        >
                            <span class="menubar-status-icon-svg" data-icon="bluetooth"></span>
                        </button>
                        <div
                            id="bluetooth-menu"
                            class="menu-dropdown menu-right hidden system-dropdown"
                            aria-labelledby="bluetooth-status-trigger"
                        >
                            <div class="system-section" role="presentation">
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    aria-pressed="true"
                                    data-system-action="toggle-bluetooth"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.toggles.bluetooth"
                                        >Bluetooth</span
                                    >
                                    <span class="system-state-pill" data-state="bluetooth"></span>
                                </button>
                            </div>
                            <div class="system-section" role="presentation">
                                <p
                                    class="system-section-title"
                                    data-i18n="menubar.bluetooth.devices"
                                >
                                    Ger√§te
                                </p>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-device="AirPods"
                                    aria-pressed="true"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.bluetooth.airpods"
                                        >Marvins AirPods Pro</span
                                    >
                                    <span
                                        class="system-network-indicator"
                                        data-i18n="menubar.state.connected"
                                        >Verbunden</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-device="Keyboard"
                                    aria-pressed="false"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.bluetooth.keyboard"
                                        >Magic Keyboard</span
                                    >
                                    <span
                                        class="system-network-indicator"
                                        data-i18n="menubar.state.ready"
                                        >Bereit</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-device="Speaker"
                                    aria-pressed="false"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.bluetooth.speaker"
                                        >HomeSpeaker</span
                                    >
                                    <span
                                        class="system-network-indicator"
                                        data-i18n="menubar.state.notConnected"
                                        >Nicht verbunden</span
                                    >
                                </button>
                            </div>
                            <div class="system-section" role="presentation">
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-system-action="open-bluetooth"
                                    data-i18n-aria-label="menubar.actions.bluetoothSettings"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.actions.bluetoothSettings"
                                        >Bluetooth-Einstellungen ‚Ä¶</span
                                    >
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="menubar-trigger menubar-status-trigger">
                        <button
                            id="sound-status-trigger"
                            type="button"
                            class="menubar-status-icon"
                            aria-label="Ton"
                            data-i18n-aria-label="menubar.sound.label"
                            aria-haspopup="menu"
                            aria-expanded="false"
                            aria-controls="sound-menu"
                            data-system-menu-trigger="sound"
                        >
                            <span class="menubar-status-icon-svg" data-icon="volume"></span>
                        </button>
                        <div
                            id="sound-menu"
                            class="menu-dropdown menu-right hidden system-dropdown"
                            aria-labelledby="sound-status-trigger"
                        >
                            <div class="system-section" role="presentation">
                                <label for="sound-volume-slider" class="system-slider-label">
                                    <span class="system-slider-icon" data-icon="volume"></span>
                                    <span data-i18n="menubar.controlCenter.volume">Lautst√§rke</span>
                                    <span class="system-slider-value" data-state="volume"></span>
                                </label>
                                <input
                                    id="sound-volume-slider"
                                    type="range"
                                    min="0"
                                    max="100"
                                    value="65"
                                    class="system-slider"
                                    data-system-slider="volume"
                                />
                            </div>
                            <div
                                class="system-section"
                                role="presentation"
                                data-i18n-aria-label="menubar.sound.outputDevices"
                            >
                                <p
                                    class="system-section-title"
                                    data-i18n="menubar.sound.outputDevices"
                                >
                                    Ausgabeger√§te
                                </p>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    aria-pressed="true"
                                    data-audio-device="speakers"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.sound.devices.speakers"
                                        >MacBook Lautsprecher</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    aria-pressed="false"
                                    data-audio-device="airpods"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.sound.devices.airpods"
                                        >Marvins AirPods Pro</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    aria-pressed="false"
                                    data-audio-device="display"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.sound.devices.display"
                                        >Samsung Monitor</span
                                    >
                                </button>
                            </div>
                            <div class="system-section" role="presentation">
                                <button
                                    type="button"
                                    class="menu-item system-menu-item"
                                    data-system-action="open-sound"
                                    data-i18n-aria-label="menubar.actions.soundSettings"
                                >
                                    <span
                                        class="menu-item-label"
                                        data-i18n="menubar.actions.soundSettings"
                                        >Ton-Einstellungen ‚Ä¶</span
                                    >
                                </button>
                            </div>
                        </div>
                    </div>
                    <div
                        class="menubar-status menubar-battery"
                        aria-label="Batteriestatus"
                        title="Batterie vollst√§ndig geladen"
                        data-i18n-aria-label="menubar.battery.label"
                        data-i18n-title="menubar.battery.fullLabel"
                    >
                        <span class="menubar-status-icon-svg" data-icon="battery"></span>
                        <span class="menubar-battery-label" data-state="battery">100%</span>
                    </div>
                    <button
                        class="menubar-status-icon"
                        type="button"
                        data-system-action="open-spotlight"
                        aria-label="Spotlight Suche"
                        title="Spotlight"
                        data-i18n-aria-label="menubar.actions.spotlight"
                        data-i18n-title="menubar.actions.spotlight"
                    >
                        <svg
                            width="17"
                            height="17"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                            focusable="false"
                        >
                            <path
                                d="M11 4a7 7 0 0 1 5.46 11.31l3.11 3.12-1.41 1.41-3.12-3.11A7 7 0 1 1 11 4m0 2a5 5 0 1 0 .001 10.001A5 5 0 0 0 11 6z"
                                fill="currentColor"
                            />
                        </svg>
                    </button>
                    <button
                        class="menubar-status-icon"
                        type="button"
                        data-system-action="open-siri"
                        aria-label="Siri"
                        title="Siri"
                        data-i18n-aria-label="menubar.actions.siri"
                        data-i18n-title="menubar.actions.siri"
                    >
                        <svg
                            width="17"
                            height="17"
                            viewBox="0 0 24 24"
                            aria-hidden="true"
                            focusable="false"
                        >
                            <path
                                d="M12 2c2.21 0 4 1.79 4 4v4c0 2.21-1.79 4-4 4s-4-1.79-4-4V6c0-2.21 1.79-4 4-4m0 18c-3.31 0-6-2.69-6-6h1.5a4.5 4.5 0 1 0 9 0H18c0 3.31-2.69 6-6 6m-1 2h2v2h-2z"
                                fill="currentColor"
                            />
                        </svg>
                    </button>
                    <div class="menubar-trigger menubar-status-trigger">
                        <button
                            id="control-center-trigger"
                            type="button"
                            class="menubar-status-icon"
                            aria-label="Kontrollzentrum"
                            title="Kontrollzentrum"
                            data-i18n-aria-label="menubar.controlCenter.label"
                            data-i18n-title="menubar.controlCenter.label"
                            aria-haspopup="menu"
                            aria-expanded="false"
                            aria-controls="control-center-menu"
                            data-system-menu-trigger="control-center"
                        >
                            <svg
                                width="17"
                                height="17"
                                viewBox="0 0 24 24"
                                aria-hidden="true"
                                focusable="false"
                            >
                                <path
                                    d="M6 4h6a2 2 0 0 1 2 2v4H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2m6 10H6a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h6v-6m2 0h6v6h-6v-6m0-2h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-6v6Z"
                                    fill="currentColor"
                                />
                            </svg>
                        </button>
                        <div
                            id="control-center-menu"
                            class="menu-dropdown menu-right hidden system-dropdown"
                            aria-labelledby="control-center-trigger"
                        >
                            <div class="system-section" role="presentation">
                                <h3
                                    class="system-section-title"
                                    data-i18n="menubar.controlCenter.quickActions"
                                >
                                    Schnellaktionen
                                </h3>
                                <div
                                    class="system-toggle-grid"
                                    role="group"
                                    data-i18n-aria-label="menubar.controlCenter.quickActionsAria"
                                >
                                    <button
                                        type="button"
                                        class="system-toggle"
                                        data-system-toggle="wifi"
                                        aria-pressed="true"
                                    >
                                        <span class="system-toggle-icon" data-icon="wifi"></span>
                                        <span
                                            class="system-toggle-label"
                                            data-i18n="menubar.toggles.wifi"
                                            >WLAN</span
                                        >
                                        <span class="system-toggle-status" data-state="wifi"></span>
                                    </button>
                                    <button
                                        type="button"
                                        class="system-toggle"
                                        data-system-toggle="bluetooth"
                                        aria-pressed="true"
                                    >
                                        <span
                                            class="system-toggle-icon"
                                            data-icon="bluetooth"
                                        ></span>
                                        <span
                                            class="system-toggle-label"
                                            data-i18n="menubar.toggles.bluetooth"
                                            >Bluetooth</span
                                        >
                                        <span
                                            class="system-toggle-status"
                                            data-state="bluetooth"
                                        ></span>
                                    </button>
                                    <button
                                        type="button"
                                        class="system-toggle"
                                        data-system-toggle="focus"
                                        aria-pressed="false"
                                    >
                                        <span class="system-toggle-icon" data-icon="moon"></span>
                                        <span
                                            class="system-toggle-label"
                                            data-i18n="menubar.toggles.focus"
                                            >Fokus</span
                                        >
                                        <span
                                            class="system-toggle-status"
                                            data-state="focus"
                                        ></span>
                                    </button>
                                    <button
                                        type="button"
                                        class="system-toggle"
                                        data-system-toggle="dark-mode"
                                        aria-pressed="false"
                                    >
                                        <span
                                            class="system-toggle-icon"
                                            data-icon="appearance"
                                        ></span>
                                        <span
                                            class="system-toggle-label"
                                            data-i18n="menubar.toggles.darkMode"
                                            >Dark Mode</span
                                        >
                                        <span
                                            class="system-toggle-status"
                                            data-state="dark-mode"
                                        ></span>
                                    </button>
                                </div>
                            </div>
                            <div class="system-section" role="presentation">
                                <label for="system-brightness" class="system-slider-label">
                                    <span class="system-slider-icon" data-icon="sun"></span>
                                    <span data-i18n="menubar.controlCenter.brightness"
                                        >Helligkeit</span
                                    >
                                    <span
                                        class="system-slider-value"
                                        data-state="brightness"
                                    ></span>
                                </label>
                                <input
                                    id="system-brightness"
                                    type="range"
                                    min="10"
                                    max="100"
                                    value="80"
                                    class="system-slider"
                                    data-system-slider="brightness"
                                />
                                <label for="system-volume" class="system-slider-label">
                                    <span class="system-slider-icon" data-icon="volume"></span>
                                    <span data-i18n="menubar.controlCenter.volume">Lautst√§rke</span>
                                    <span class="system-slider-value" data-state="volume"></span>
                                </label>
                                <input
                                    id="system-volume"
                                    type="range"
                                    min="0"
                                    max="100"
                                    value="65"
                                    class="system-slider"
                                    data-system-slider="volume"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                <span id="clock" class="menubar-clock no-select" aria-live="polite"></span>
            </div>
        </header>
        <!-- Desktop -->
        <div id="desktop" class="desktop-area" aria-label="Desktop">
            <div
                id="desktop-icons"
                class="desktop-icon-column"
                role="list"
                aria-label="Desktop Icons"
            >
                <!-- Desktop icons are rendered dynamically -->
            </div>
        </div>
        <!-- Projekte Modal -->
        <div id="projects-modal" class="fixed inset-0 hidden modal">
            <div class="absolute inset-0 flex items-center justify-center">
                <!-- Projekte nutzen nun einen flexiblen Container, der sich an der Fenstergr√∂√üe orientiert. -->
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg autopointer flex flex-col min-h-0 w-[70vw] h-[60vh] max-h-[85vh]"
                >
                    <div
                        class="flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-t-lg draggable-header"
                    >
                        <div class="flex space-x-2">
                            <button
                                title="Schlie√üen"
                                data-i18n-title="common.close"
                                id="close-projects-modal"
                                data-action="closeWindow"
                                data-window-id="projects-modal"
                                class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                            >
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            </button>
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        </div>
                        <h2
                            class="ml-4 font-semibold text-gray-700 dark:text-gray-300 no-select"
                            data-i18n="modals.projects.title"
                        >
                            Projekte
                        </h2>
                    </div>
                    <div class="p-4 flex-1 flex flex-col h-full">
                        <div class="flex gap-4 h-full min-h-0">
                            <!-- Seitenleiste mit allen Repositories -->
                            <aside
                                id="repo-sidebar"
                                class="w-64 max-w-sm bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden flex flex-col min-h-0"
                            >
                                <div
                                    class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400 uppercase tracking-wide"
                                    data-i18n="modals.projects.repositories"
                                >
                                    Repositories
                                </div>
                                <ul
                                    id="repo-list"
                                    class="flex-1 overflow-auto divide-y divide-gray-200 dark:divide-gray-700 m-0 p-0 list-none max-h-full"
                                ></ul>
                            </aside>
                            <!-- Dateiansicht √§hnlich dem Finder -->
                            <section
                                id="finder-content"
                                class="flex-1 bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg flex flex-col min-h-0"
                            >
                                <div
                                    id="finder-placeholder"
                                    class="m-auto text-center text-gray-500 dark:text-gray-400 px-6"
                                    data-i18n="modals.projects.placeholder"
                                >
                                    W√§hle ein Repository aus, um dessen Dateien zu sehen.
                                </div>
                                <div id="finder-main" class="hidden h-full">
                                    <div class="flex flex-col h-full">
                                        <div
                                            id="finder-breadcrumbs"
                                            class="px-4 py-2 border-b border-gray-200 dark:border-gray-700 text-sm text-gray-600 dark:text-gray-300"
                                        ></div>

                                        <!-- Fallback bootstrap to guarantee init + visibility + __APP_READY
                                             This is intentionally defensive to support bundle/non-bundle modes
                                             and recover from rare load-event issues that can leave the app in
                                             an unready state (causing E2E readiness timeouts) or hide desktop
                                             icons. It is idempotent and only runs if the main init/ready flags
                                             have not completed yet. -->
                                        <script>
                                            (() => {
                                                const w = window;
                                                if (w.__FALLBACK_INIT_ATTEMPTED) return;
                                                w.__FALLBACK_INIT_ATTEMPTED = true;

                                                const startInit = () => {
                                                    try {
                                                        if (typeof w.initApp === 'function') {
                                                            w.initApp();
                                                        }
                                                    } catch (e) {
                                                        console.warn(
                                                            '[Fallback Init] initApp failed:',
                                                            e
                                                        );
                                                    }
                                                };

                                                if (
                                                    document.readyState === 'complete' ||
                                                    document.readyState === 'interactive'
                                                ) {
                                                    startInit();
                                                } else {
                                                    document.addEventListener(
                                                        'DOMContentLoaded',
                                                        startInit,
                                                        { once: true }
                                                    );
                                                }

                                                const ensureDesktopIcons = () => {
                                                    try {
                                                        const container =
                                                            document.getElementById(
                                                                'desktop-icons'
                                                            );
                                                        if (container) {
                                                            container.classList.remove('hidden');
                                                            container.style.visibility =
                                                                container.style.visibility ||
                                                                'visible';
                                                            container.style.display =
                                                                container.style.display || '';
                                                            if (
                                                                container.children.length === 0 &&
                                                                w.DesktopSystem?.initDesktop
                                                            ) {
                                                                w.DesktopSystem.initDesktop();
                                                            }
                                                        }
                                                    } catch (e) {
                                                        console.warn(
                                                            '[Fallback Init] ensureDesktopIcons failed:',
                                                            e
                                                        );
                                                    }
                                                };

                                                const hasCore = () =>
                                                    !!(
                                                        w.ActionBus &&
                                                        w.WindowRegistry &&
                                                        w.DockSystem
                                                    );
                                                const markReadyFallback = label => {
                                                    try {
                                                        if (!w.__APP_READY && hasCore()) {
                                                            console.info(
                                                                `[Fallback Init] __APP_READY via ${label}`
                                                            );
                                                            w.__APP_READY = true;
                                                        }
                                                    } catch (e) {
                                                        console.warn(
                                                            '[Fallback Init] markReady failed:',
                                                            e
                                                        );
                                                    }
                                                };

                                                // Staggered retries to survive slow loads
                                                [500, 1500, 3000, 5000, 8000, 12000].forEach(
                                                    delay => {
                                                        setTimeout(() => {
                                                            ensureDesktopIcons();
                                                            markReadyFallback(`t+${delay}ms`);
                                                        }, delay);
                                                    }
                                                );
                                            })();
                                        </script>
                                        <!-- Preview container (used by PreviewInstanceManager) -->
                                        <div>
                                            <div
                                                id="preview-container"
                                                class="fixed inset-0 pointer-events-none z-[2500]"
                                            ></div>

                                            class="flex-1 overflow-auto min-h-0" >
                                            <ul
                                                id="repo-files"
                                                class="divide-y divide-gray-200 dark:divide-gray-700 m-0 p-0 list-none max-h-full"
                                            ></ul>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
            <!-- √úber mich Modal -->
            <div id="about-modal" class="fixed inset-0 hidden modal" data-no-resize="true">
                <div class="absolute inset-0 flex items-center justify-center">
                    <div
                        class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg autopointer w-[320px] h-[440px]"
                    >
                        <div
                            class="flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-t-lg draggable-header"
                        >
                            <div class="flex space-x-2">
                                <button
                                    title="Schlie√üen"
                                    data-i18n-title="common.close"
                                    id="close-about-modal"
                                    data-action="closeWindow"
                                    data-window-id="about-modal"
                                    class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                                >
                                    <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                </button>
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            </div>
                            <h2
                                class="ml-4 font-semibold text-gray-700 dark:text-gray-300 no-select"
                                data-i18n="modals.about.title"
                            >
                                √úber Marvin
                            </h2>
                        </div>
                        <div
                            class="flex flex-col items-center text-gray-700 dark:text-gray-200 mt-8"
                        >
                            <img
                                src="./img/profil.jpg"
                                alt="Bild"
                                class="w-24 h-24 object-contain mb-4"
                            />
                            <h2 class="text-xl font-semibold">Marvin Temmen</h2>
                            <p class="text-sm" data-i18n="modals.about.birth">M√§rz 1999</p>
                            <div class="mt-4 space-y-1 text-sm">
                                <p>
                                    <strong data-i18n="modals.about.locationLabel">Wohnort</strong>:
                                    <span data-i18n="modals.about.locationValue">Deutschland</span>
                                </p>
                                <p>
                                    <strong data-i18n="modals.about.jobLabel">Beruf</strong>:
                                    <span data-i18n="modals.about.jobValue"
                                        >Softwareentwickler</span
                                    >
                                </p>
                                <p>
                                    <strong data-i18n="modals.about.employerLabel"
                                        >Arbeitgeber</strong
                                    >:
                                    <span data-i18n="modals.about.employerValue">WinWorker</span>
                                </p>
                            </div>
                            <button
                                class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
                                data-action="openWindow"
                                data-window-id="settings-modal"
                            >
                                <span data-i18n="modals.about.moreButton">Mehr Infos ‚Ä¶</span>
                            </button>
                            <div
                                class="mt-6 text-xs text-center text-gray-500 dark:text-gray-400 border-t border-gray-300 dark:border-gray-700 pt-2"
                            >
                                <span data-i18n="modals.about.copyright"
                                    >¬© 2025 Marvin T. ‚Äî Alle Rechte vorbehalten.</span
                                >
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Einstellungen Modal -->
                <div id="settings-modal" class="fixed inset-0 hidden modal">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <!--
                    Die Einstellungen werden in einem adaptiven Dialog angezeigt. Statt IFrames wird das
                    UI inline √ºber das SettingsSystem in den Container gerendert. Der flexible Container
                    passt sich dem Viewport an; √ºber das Resize‚ÄëHandle kann die Fenstergr√∂√üe angepasst
                    werden.
                -->
                        <div
                            class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg autopointer flex flex-col w-[80vw] h-[70vh] max-h-[90vh]"
                        >
                            <!-- Header -->
                            <div
                                class="flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-t-lg draggable-header"
                            >
                                <div class="flex space-x-2">
                                    <button
                                        title="Schlie√üen"
                                        data-i18n-title="common.close"
                                        id="close-settings-modal"
                                        data-action="closeWindow"
                                        data-window-id="settings-modal"
                                        class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                                    >
                                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    </button>
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <h2
                                    class="ml-4 font-semibold text-gray-700 dark:text-gray-300 no-select"
                                    data-i18n="modals.settings.title"
                                >
                                    Systemeinstellungen
                                </h2>
                            </div>
                            <!-- Content -->
                            <!-- Settings rendered inline via SettingsSystem module -->
                            <div id="settings-container" class="flex-1 overflow-hidden"></div>
                        </div>
                    </div>
                </div>
                <!-- Texteditor Modal -->
                <div id="text-modal" class="fixed inset-0 hidden modal">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <!--
                    Der Texteditordialog verwendet ebenfalls einen flexiblen Container und rendert den
                    Editor inline √ºber das TextEditorSystem (kein IFrame). Prozentuale Breite/H√∂he lassen
                    das Fenster je nach Bildschirmgr√∂√üe wachsen oder schrumpfen.
                -->
                        <div
                            class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg autopointer flex flex-col w-[70vw] h-[60vh] max-h-[85vh]"
                        >
                            <!-- Header -->
                            <div
                                class="flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-t-lg draggable-header"
                            >
                                <div class="flex space-x-2">
                                    <button
                                        title="Schlie√üen"
                                        data-i18n-title="common.close"
                                        id="close-text-modal"
                                        data-action="closeWindow"
                                        data-window-id="text-modal"
                                        class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                                    >
                                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                    </button>
                                    <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                    <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                </div>
                                <h2
                                    class="ml-4 font-semibold text-gray-700 dark:text-gray-300 no-select"
                                    data-i18n="modals.text.title"
                                >
                                    Texteditor
                                </h2>
                            </div>
                            <!-- Tab container for multiple editor instances -->
                            <div id="text-editor-tabs-container"></div>
                            <!-- Content -->
                            <!-- Text editor rendered inline via TextEditorSystem module -->
                            <div id="text-editor-container" class="flex-1 overflow-hidden"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Launchpad Modal -->
        <div id="launchpad-modal" class="fixed inset-0 hidden modal launchpad-modal-wrapper">
            <div class="absolute inset-0 flex items-center justify-center">
                <div
                    class="launchpad-modal-inner autopointer rounded-2xl overflow-hidden shadow-2xl flex flex-col w-[min(75vw,900px)] h-[min(70vh,700px)]"
                >
                    <!-- Content (no header/title bar) -->
                    <div id="launchpad-container" class="flex-1 overflow-hidden"></div>
                </div>
            </div>
        </div>
        <!-- Programminfo Modal -->
        <div id="program-info-modal" class="fixed inset-0 hidden modal" data-no-resize="true">
            <div class="absolute inset-0 flex items-center justify-center">
                <div
                    class="bg-white dark:bg-gray-900 rounded-2xl overflow-hidden shadow-xl autopointer flex flex-col w-[min(360px,90vw)]"
                >
                    <div
                        class="flex items-center px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-t-2xl draggable-header"
                    >
                        <div class="flex space-x-2">
                            <button
                                title="Schlie√üen"
                                data-i18n-title="common.close"
                                id="close-program-info-modal"
                                data-action="closeWindow"
                                data-window-id="program-info-modal"
                                class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                            >
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            </button>
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        </div>
                        <h2
                            class="ml-4 font-semibold text-gray-700 dark:text-gray-300 no-select"
                            data-i18n="modals.programInfo.title"
                        >
                            √úber dieses Programm
                        </h2>
                    </div>
                    <div class="p-6 flex flex-col items-center text-center gap-4">
                        <img
                            id="program-info-icon"
                            src=""
                            alt=""
                            class="w-20 h-20 rounded-2xl shadow-md hidden"
                        />
                        <div class="flex flex-col gap-2">
                            <p
                                id="program-info-name"
                                class="text-xl font-semibold text-gray-900 dark:text-gray-100"
                            ></p>
                            <p
                                id="program-info-tagline"
                                class="text-sm text-gray-600 dark:text-gray-300"
                            ></p>
                            <p
                                id="program-info-version"
                                class="text-sm font-medium text-gray-700 dark:text-gray-200"
                            ></p>
                        </div>
                        <p
                            id="program-info-copyright"
                            class="text-xs text-gray-500 dark:text-gray-400"
                        ></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Terminal Modal -->
        <div id="terminal-modal" class="fixed inset-0 hidden modal">
            <div class="absolute inset-0 flex items-center justify-center">
                <div
                    class="bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-lg autopointer flex flex-col w-[min(80vw,1000px)] h-[min(70vh,600px)]"
                >
                    <div
                        class="flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-t-lg draggable-header"
                    >
                        <div class="flex space-x-2">
                            <button
                                title="Schlie√üen"
                                data-i18n-title="common.close"
                                id="close-terminal-modal"
                                data-action="closeWindow"
                                data-window-id="terminal-modal"
                                class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                            >
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            </button>
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        </div>
                        <h2
                            class="ml-4 font-semibold text-gray-700 dark:text-gray-300 no-select"
                            data-i18n="modals.terminal.title"
                        >
                            Terminal
                        </h2>
                    </div>
                    <!-- Tab container for multiple terminal instances -->
                    <div id="terminal-tabs-container"></div>
                    <div id="terminal-container" class="flex-1 overflow-hidden"></div>
                </div>
            </div>
        </div>

        <!-- Bildbetrachter Modal -->
        <div id="image-modal" class="fixed inset-0 items-center justify-center hidden modal">
            <div
                class="bg-white dark:bg-gray-900 rounded-3xl overflow-hidden shadow-2xl autopointer flex flex-col w-[min(90vw,1100px)] h-[min(85vh,780px)]"
            >
                <div
                    class="flex items-center px-5 py-3 bg-gray-200/80 dark:bg-gray-800/80 backdrop-blur rounded-t-3xl draggable-header"
                >
                    <div class="flex space-x-2">
                        <button
                            title="Schlie√üen"
                            data-i18n-title="common.close"
                            id="close-image-modal"
                            data-action="closeWindow"
                            data-window-id="image-modal"
                            class="ml-auto text-2xl leading-none text-gray-700 dark:text-gray-300"
                        >
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        </button>
                        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                    </div>
                    <h2
                        class="ml-4 font-semibold text-lg text-gray-800 dark:text-gray-100 tracking-wide no-select"
                        data-i18n="photos.title"
                    >
                        Fotos
                    </h2>
                    <div
                        class="ml-auto flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400"
                    >
                        <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-white/70 dark:bg-gray-900/70 border border-gray-300 dark:border-gray-700"
                        >
                            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                            <span data-i18n="photos.badge">PICSUM CLOUD</span>
                        </span>
                    </div>
                </div>
                <div class="flex flex-1 min-h-0">
                    <aside
                        class="hidden md:flex flex-col w-56 border-r border-gray-200 dark:border-gray-800 bg-gray-50/80 dark:bg-gray-900/60"
                    >
                        <div class="px-5 pt-6 pb-4">
                            <p
                                class="text-xs uppercase tracking-[0.2em] text-gray-400 dark:text-gray-500"
                                data-i18n="photos.sidebar.library"
                            >
                                Bibliothek
                            </p>
                            <nav class="mt-4 space-y-1" id="photos-sidebar">
                                <button
                                    type="button"
                                    data-photos-filter="all"
                                    class="photos-sidebar-button"
                                >
                                    <span data-i18n="photos.sidebar.items.all">Alle Fotos</span>
                                    <span id="photos-count-all" class="photos-sidebar-count"
                                        >‚Äì</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    data-photos-filter="favorites"
                                    class="photos-sidebar-button"
                                >
                                    <span data-i18n="photos.sidebar.items.favorites"
                                        >Favoriten</span
                                    >
                                    <span id="photos-count-favorites" class="photos-sidebar-count"
                                        >0</span
                                    >
                                </button>
                            </nav>
                            <p
                                class="text-xs uppercase tracking-[0.2em] text-gray-400 dark:text-gray-500 mt-6"
                                data-i18n="photos.sidebar.filters"
                            >
                                Filter
                            </p>
                            <nav class="mt-4 space-y-1">
                                <button
                                    type="button"
                                    data-photos-filter="landscape"
                                    class="photos-sidebar-button"
                                >
                                    <span data-i18n="photos.sidebar.items.landscape"
                                        >Querformat</span
                                    >
                                    <span id="photos-count-landscape" class="photos-sidebar-count"
                                        >‚Äì</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    data-photos-filter="portrait"
                                    class="photos-sidebar-button"
                                >
                                    <span data-i18n="photos.sidebar.items.portrait"
                                        >Hochformat</span
                                    >
                                    <span id="photos-count-portrait" class="photos-sidebar-count"
                                        >‚Äì</span
                                    >
                                </button>
                                <button
                                    type="button"
                                    data-photos-filter="square"
                                    class="photos-sidebar-button"
                                >
                                    <span data-i18n="photos.sidebar.items.square">Quadratisch</span>
                                    <span id="photos-count-square" class="photos-sidebar-count"
                                        >‚Äì</span
                                    >
                                </button>
                            </nav>
                        </div>
                        <div class="px-5 pb-6 mt-auto">
                            <button
                                id="photos-refresh"
                                type="button"
                                class="w-full inline-flex items-center justify-center gap-2 px-3 py-2 text-sm font-medium rounded-2xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 transition hover:border-blue-400 hover:text-blue-600 dark:hover:border-blue-400 dark:hover:text-blue-300"
                            >
                                <span aria-hidden="true">‚Üª</span>
                                <span data-i18n="photos.sidebar.refresh">Neu laden</span>
                            </button>
                            <p
                                class="text-[11px] text-gray-400 dark:text-gray-500 mt-3 leading-relaxed"
                                data-i18n="photos.sidebar.sourceNote"
                            >
                                Quelle: Lorem Picsum ‚Äì zuf√§llige kuratierte Fotokollektionen.
                            </p>
                        </div>
                    </aside>
                    <div class="flex-1 flex flex-col min-h-0 relative">
                        <div
                            class="px-5 sm:px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-white/60 dark:bg-gray-900/60 backdrop-blur"
                        >
                            <div class="flex flex-wrap items-center gap-3">
                                <div
                                    class="flex bg-gray-200 dark:bg-gray-800 rounded-full p-1 text-sm font-medium text-gray-600 dark:text-gray-300 shadow-inner"
                                    role="group"
                                >
                                    <button
                                        type="button"
                                        data-photos-segment="moments"
                                        class="photos-segment-button"
                                        data-i18n="photos.segments.moments"
                                    >
                                        Momente
                                    </button>
                                    <button
                                        type="button"
                                        data-photos-segment="collections"
                                        class="photos-segment-button"
                                        data-i18n="photos.segments.collections"
                                    >
                                        Sammlungen
                                    </button>
                                    <button
                                        type="button"
                                        data-photos-segment="years"
                                        class="photos-segment-button"
                                        data-i18n="photos.segments.years"
                                    >
                                        Jahre
                                    </button>
                                </div>
                                <div class="flex items-center gap-3 ml-auto w-full sm:w-auto">
                                    <div class="relative flex-1 sm:flex-initial">
                                        <input
                                            id="photos-search"
                                            type="search"
                                            placeholder="Nach Autor suchen"
                                            data-i18n-placeholder="photos.search.placeholder"
                                            class="w-full sm:w-56 rounded-2xl border border-gray-300 dark:border-gray-700 bg-white/70 dark:bg-gray-900/70 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                        />
                                        <button
                                            id="photos-search-clear"
                                            type="button"
                                            class="absolute inset-y-0 right-2 flex items-center text-xl text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300"
                                            title="Suche l√∂schen"
                                            data-i18n-title="photos.search.clear"
                                        >
                                            √ó
                                        </button>
                                    </div>
                                    <div
                                        class="hidden sm:flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300"
                                    >
                                        <span
                                            id="photo-count"
                                            class="font-medium"
                                            data-i18n="photos.status.countPlaceholder"
                                            >‚Äì Fotos</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 relative min-h-0">
                            <div
                                id="photos-loading"
                                class="absolute inset-0 items-center justify-center bg-white/80 dark:bg-gray-900/80 z-20 hidden"
                            >
                                <div
                                    class="flex flex-col items-center gap-2 text-gray-600 dark:text-gray-300"
                                >
                                    <span
                                        class="h-10 w-10 border-4 border-gray-300 dark:border-gray-700 border-t-blue-500 dark:border-t-blue-400 rounded-full animate-spin"
                                    ></span>
                                    <span
                                        class="text-sm font-medium"
                                        data-i18n="photos.status.loading"
                                        >Lade Fotos‚Ä¶</span
                                    >
                                </div>
                            </div>
                            <div
                                id="photos-error"
                                class="absolute inset-x-0 top-6 mx-auto max-w-lg bg-red-50 dark:bg-red-900/40 text-red-700 dark:text-red-200 rounded-2xl shadow px-5 py-4 hidden"
                            >
                                <p class="font-semibold mb-1" data-i18n="photos.errors.heading">
                                    Fehler beim Laden
                                </p>
                                <p class="text-sm" data-i18n="photos.errors.description">
                                    Bitte √ºberpr√ºfe deine Verbindung und versuche es erneut.
                                </p>
                                <button
                                    id="photos-error-retry"
                                    type="button"
                                    class="mt-3 inline-flex items-center gap-2 text-sm font-medium text-red-700 dark:text-red-100 underline decoration-dotted"
                                    data-i18n="photos.buttons.retry"
                                >
                                    Erneut versuchen
                                </button>
                            </div>
                            <div
                                id="photos-gallery"
                                class="absolute inset-0 overflow-y-auto px-5 sm:px-6 py-6 space-y-8"
                            ></div>
                            <div
                                id="photos-empty"
                                class="absolute inset-0 items-center justify-center text-center text-gray-500 dark:text-gray-400 hidden px-6"
                            >
                                <div>
                                    <p class="text-lg font-semibold" data-i18n="photos.empty.title">
                                        Keine Fotos gefunden
                                    </p>
                                    <p class="text-sm mt-1" data-i18n="photos.empty.description">
                                        Passe Suche oder Filter an, um weitere Ergebnisse zu sehen.
                                    </p>
                                </div>
                            </div>
                            <div
                                id="image-placeholder"
                                class="absolute inset-0 items-center justify-center text-gray-500 dark:text-gray-400 text-center px-6 hidden pointer-events-none"
                                data-i18n="photos.placeholder"
                            >
                                W√§hle ein Foto aus, um Details zu sehen.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div
                id="photo-detail-overlay"
                class="absolute inset-0 hidden items-center justify-center px-4 py-10 bg-black/50 backdrop-blur-sm z-30"
            >
                <div
                    class="bg-white dark:bg-gray-900 rounded-3xl shadow-2xl overflow-hidden max-w-5xl w-full h-full flex flex-col"
                >
                    <div
                        class="flex items-center gap-4 px-6 py-4 border-b border-gray-200 dark:border-gray-800"
                    >
                        <div class="flex-1 min-w-0">
                            <p
                                id="photo-detail-title"
                                class="text-xl font-semibold text-gray-900 dark:text-gray-100 truncate"
                                data-i18n="photos.detail.titleFallback"
                            >
                                Foto
                            </p>
                            <p
                                id="photo-detail-meta"
                                class="text-sm text-gray-500 dark:text-gray-400 mt-1 truncate"
                            ></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                id="photo-detail-favorite"
                                type="button"
                                class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-sm font-medium transition hover:bg-gray-200 dark:hover:bg-gray-700"
                            >
                                <span aria-hidden="true">‚ô°</span>
                                <span data-i18n="photos.detail.favoriteAdd">Zu Favoriten</span>
                            </button>
                            <a
                                id="photo-detail-download"
                                class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-blue-600 text-white text-sm font-medium transition hover:bg-blue-500"
                                href="#"
                                target="_blank"
                                rel="noreferrer"
                                data-i18n="photos.detail.download"
                            >
                                Herunterladen
                            </a>
                            <button
                                id="photo-detail-close"
                                type="button"
                                class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-200 text-lg leading-none transition hover:bg-gray-200 dark:hover:bg-gray-700"
                                title="Schlie√üen"
                                data-i18n-title="common.close"
                            >
                                √ó
                            </button>
                        </div>
                    </div>
                    <div class="flex-1 flex overflow-hidden">
                        <button
                            id="photo-detail-prev"
                            type="button"
                            class="hidden sm:flex items-center justify-center w-14 bg-transparent text-3xl text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition"
                            title="Vorheriges Foto"
                            data-i18n-title="photos.detail.prev"
                        >
                            ‚Äπ
                        </button>
                        <div
                            class="flex-1 relative bg-gray-50 dark:bg-gray-950 flex items-center justify-center overflow-hidden"
                        >
                            <img
                                id="image-viewer"
                                class="max-w-full max-h-full object-contain"
                                alt="Ausgew√§hltes Foto"
                                data-i18n-alt="photos.detail.imageAlt"
                            />
                            <div
                                id="photo-detail-loader"
                                class="absolute inset-0 items-center justify-center bg-gray-900/40 text-white text-sm font-medium hidden"
                                data-i18n="photos.detail.loader"
                            >
                                Foto wird geladen‚Ä¶
                            </div>
                        </div>
                        <button
                            id="photo-detail-next"
                            type="button"
                            class="hidden sm:flex items-center justify-center w-14 bg-transparent text-3xl text-gray-400 dark:text-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition"
                            title="N√§chstes Foto"
                            data-i18n-title="photos.detail.next"
                        >
                            ‚Ä∫
                        </button>
                    </div>
                    <div
                        class="px-6 py-4 border-t border-gray-200 dark:border-gray-800 flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600 dark:text-gray-300"
                    >
                        <div class="flex-1 min-w-[200px]">
                            <p
                                id="image-info"
                                class="font-medium text-gray-700 dark:text-gray-200"
                            ></p>
                            <p
                                id="photo-detail-dimensions"
                                class="text-xs text-gray-500 dark:text-gray-400 mt-1"
                            ></p>
                        </div>
                        <div class="flex items-center gap-4">
                            <span
                                id="photo-detail-counter"
                                class="text-sm text-gray-500 dark:text-gray-400"
                            ></span>
                            <a
                                id="photo-detail-open"
                                class="text-sm text-blue-600 dark:text-blue-400 hover:underline"
                                href="#"
                                target="_blank"
                                rel="noreferrer"
                                data-i18n="photos.detail.open"
                            >
                                Auf Lorem Picsum ansehen
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dock -->
        <!-- Inline styles ensure the dock remains visible in test environments
           where CSS can be missing or applied late. Kept minimal and harmless. -->
        <!-- stylelint-disable-next-line -->
        <div
            id="dock"
            class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[2000] flex visible opacity-100"
        >
            <div class="dock-tray inline-flex items-end gap-2 px-3 py-2">
                <!-- Finder -->
                <div
                    class="dock-item group relative flex flex-col items-center cursor-pointer"
                    data-action="openWindow"
                >
                    <span
                        class="dock-tooltip hidden group-hover:flex absolute bottom-full mb-2 text-xs text-white px-2 py-1 rounded z-50"
                        data-i18n="dock.finder"
                    >
                        Finder
                    </span>
                    <img src="./img/sucher.png" alt="Finder Icon" class="dock-icon" />
                    <span id="finder-indicator" class="hidden dock-indicator"></span>
                </div>
                <!-- Launchpad -->
                <div
                    class="dock-item group relative flex flex-col items-center cursor-pointer"
                    data-action="openWindow"
                    data-window-id="launchpad-modal"
                >
                    <span
                        class="dock-tooltip hidden group-hover:flex absolute bottom-full mb-2 text-xs text-white px-2 py-1 rounded z-50"
                        data-i18n="dock.launchpad"
                    >
                        Launchpad
                    </span>
                    <img src="./img/launchpad.png" alt="Launchpad Icon" class="dock-icon" />
                    <span id="launchpad-indicator" class="hidden dock-indicator"></span>
                </div>
                <!-- Texteditor -->
                <div
                    class="dock-item group relative flex flex-col items-center cursor-pointer"
                    data-action="openWindow"
                    data-window-id="text-modal"
                >
                    <span
                        class="dock-tooltip hidden group-hover:flex absolute bottom-full mb-2 text-xs text-white px-2 py-1 rounded z-50"
                        data-i18n="dock.text"
                    >
                        Texteditor
                    </span>
                    <img src="./img/notepad.png" alt="Texteditor Icon" class="dock-icon" />
                    <span id="text-indicator" class="hidden dock-indicator"></span>
                </div>
                <!-- Terminal -->
                <div
                    class="dock-item group relative flex flex-col items-center cursor-pointer"
                    data-action="openWindow"
                    data-window-id="terminal-modal"
                >
                    <span
                        class="dock-tooltip hidden group-hover:flex absolute bottom-full mb-2 text-xs text-white px-2 py-1 rounded z-50"
                        data-i18n="dock.terminal"
                    >
                        Terminal
                    </span>
                    <img src="./img/terminal.png" alt="Settings Icon" class="dock-icon" />
                    <span id="terminal-indicator" class="hidden dock-indicator"></span>
                </div>
                <!-- Einstellungen -->
                <div
                    class="dock-item group relative flex flex-col items-center cursor-pointer"
                    data-action="openWindow"
                    data-window-id="settings-modal"
                >
                    <span
                        class="dock-tooltip hidden group-hover:flex absolute bottom-full mb-2 text-xs text-white px-2 py-1 rounded z-50"
                        data-i18n="dock.settings"
                    >
                        Systemeinstellungen
                    </span>
                    <img src="./img/settings.png" alt="Settings Icon" class="dock-icon" />
                    <span id="settings-indicator" class="hidden dock-indicator"></span>
                </div>
            </div>
        </div>
        <script>
            // Uhrzeit aktualisieren (HH:MM)
            function showTab(tabName) {
                // √ñffnet das gew√ºnschte Fenster √ºber das globale Dialog-Objekt
                const modalId = tabName + '-modal';
                const el = document.getElementById(modalId);
                // Stelle sicher, dass das Dialog-Objekt existiert
                if (!window.dialogs) window.dialogs = {};
                if (!window.dialogs[modalId] && el && typeof window.Dialog === 'function') {
                    try {
                        window.dialogs[modalId] = new window.Dialog(modalId);
                    } catch (e) {
                        /* noop */
                    }
                }
                // Bevorzugt √ºber Dialog-API √∂ffnen (stellt Drag/Resize/Buttons sicher)
                const dlg = window.dialogs && window.dialogs[modalId];
                if (dlg && typeof dlg.open === 'function') {
                    dlg.open();
                } else if (el) {
                    // Fallback (robuster f√ºr Firefox / fr√ºhe Klicks): Modal-Element direkt einblenden
                    el.classList.remove('hidden');
                    if (typeof window.bringDialogToFront === 'function') {
                        window.bringDialogToFront(modalId);
                    }
                }
                // Nach dem √ñffnen: √úbersetzungen anwenden und Men√º aktualisieren
                if (
                    el &&
                    window.appI18n &&
                    typeof window.appI18n.applyTranslations === 'function'
                ) {
                    window.appI18n.applyTranslations(el);
                }
                if (typeof window.updateProgramLabelByTopModal === 'function') {
                    window.updateProgramLabelByTopModal();
                }
            }
            function updateClock() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                const timeString = `${hours}:${minutes}`;
                const clockEl = document.getElementById('clock');
                if (clockEl) {
                    clockEl.innerText = timeString;
                }
            }
            updateClock();
            setInterval(updateClock, 1000);
        </script>

        <!-- Dev-only: Live Reload client (SSE) with CSS hot-reload. Active only on localhost. -->
        <script>
            (function () {
                function bust(href) {
                    var url = new URL(href, window.location.href);
                    url.searchParams.set('lr', Date.now().toString());
                    return url.toString();
                }
                function hotReloadCSS(changedPath) {
                    var links = document.querySelectorAll('link[rel="stylesheet"]');
                    var changed = 0;
                    links.forEach(function (link) {
                        var url = new URL(link.href, window.location.href);
                        // Gleiche Origin und (grobe) Pfad-√úbereinstimmung
                        var isSameOrigin = url.origin === window.location.origin;
                        var match =
                            !changedPath ||
                            url.pathname.endsWith(changedPath.replace(/^\\\\|^\//, '')) ||
                            (url.pathname.indexOf('/dist/') !== -1 &&
                                changedPath.indexOf('/dist/') !== -1);
                        if (isSameOrigin && match) {
                            link.href = bust(link.href);
                            changed++;
                        }
                    });
                    if (!changed) {
                        // Fallback: alle lokalen Stylesheets neu laden
                        links.forEach(function (link) {
                            var url = new URL(link.href, window.location.href);
                            if (url.origin === window.location.origin) link.href = bust(link.href);
                        });
                    }
                }

                try {
                    var host = window.location.hostname;
                    if (host === 'localhost' || host === '127.0.0.1') {
                        var es = new EventSource('/livereload');
                        var timer;
                        es.addEventListener('reload', function (ev) {
                            clearTimeout(timer);
                            var data = {};
                            try {
                                data = JSON.parse(ev.data || '{}');
                            } catch (_) {}
                            timer = setTimeout(function () {
                                if (data.kind === 'css') {
                                    hotReloadCSS(data.path || '');
                                } else {
                                    window.location.reload();
                                }
                            }, 120);
                        });
                        // EventSource auto-reconnects by default
                        console.log('[LR] Live reload client connected.');
                    }
                } catch (e) {
                    console.debug('[LR] Live reload not active:', e);
                }
            })();
        </script>
        <script>
            // Hotfix: prevent recursive topZIndex setter causing stack overflow when z-index manager
            // touches window.topZIndex. Replaces the global getter/setter with a simple value store
            // and patches the manager methods to use the same store without re-entering the setter.
            (() => {
                const BASE = 1000;
                const MAX = 2147483500;
                const clamp = z => Math.min(Math.max(typeof z === 'number' ? z : BASE, BASE), MAX);
                const patch = () => {
                    const mgr = window.__zIndexManager;
                    if (!mgr || mgr.__patched) return;
                    let raw = clamp(window.__topZIndexRaw ?? window.topZIndex);
                    const setRaw = z => {
                        raw = clamp(z);
                        window.__topZIndexRaw = raw;
                        return raw;
                    };
                    mgr.__patched = true;
                    if (typeof mgr.ensureTopZIndex === 'function') {
                        mgr.ensureTopZIndex = z => setRaw(Math.max(raw, z ?? raw));
                    }
                    if (typeof mgr.getTopZIndex === 'function') {
                        mgr.getTopZIndex = () => raw;
                    }
                    if (typeof mgr.bumpZIndex === 'function') {
                        mgr.bumpZIndex = () => setRaw(raw + 1);
                    }
                    try {
                        Object.defineProperty(window, 'topZIndex', {
                            configurable: true,
                            get: () => raw,
                            set: v => setRaw(v ?? raw),
                        });
                    } catch (e) {
                        // Ignore if property is non-configurable in some environments
                    }
                };
                window.addEventListener('load', patch);
                setTimeout(patch, 0);
                setTimeout(patch, 200);
            })();
        </script>
    </body>
</html>
