<!doctype html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Window Focus Test</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                padding: 20px;
                background: #f0f0f0;
            }

            .test-section {
                background: white;
                padding: 20px;
                margin: 20px 0;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .status {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                font-family: monospace;
            }

            .status.success {
                background: #d4edda;
                color: #155724;
            }

            .status.error {
                background: #f8d7da;
                color: #721c24;
            }

            .status.info {
                background: #d1ecf1;
                color: #0c5460;
            }

            button {
                padding: 10px 20px;
                margin: 5px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            button:hover {
                background: #0056b3;
            }

            pre {
                background: #f5f5f5;
                padding: 10px;
                border-radius: 4px;
                overflow-x: auto;
            }
        </style>
    </head>

    <body>
        <h1>üîç Window Focus Restoration Test</h1>

        <div class="test-section">
            <h2>Test Instructions</h2>
            <ol>
                <li>Open the main application (index.html) in another tab</li>
                <li>Open two windows (e.g., About and Settings)</li>
                <li>Click on the back window to bring it to front</li>
                <li>Come back to this tab and click "Check Current State"</li>
                <li>Reload the main app tab</li>
                <li>Come back here and click "Check After Reload"</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>Quick Verification</h2>
            <button onclick="checkImplementation()">Check Implementation</button>
            <div id="implementation-status"></div>
        </div>

        <div class="test-section">
            <h2>Verification Results</h2>
            <div id="results"></div>
        </div>

        <script>
            function log(message, type = 'info') {
                const results = document.getElementById('results');
                const div = document.createElement('div');
                div.className = `status ${type}`;
                div.textContent = message;
                results.appendChild(div);
            }

            function checkImplementation() {
                const statusDiv = document.getElementById('implementation-status');
                statusDiv.innerHTML = '';

                // Open the main app in a new window to check
                const mainAppUrl = window.location.origin + '/index.html';
                const testWindow = window.open(mainAppUrl, '_blank', 'width=1200,height=800');

                if (!testWindow) {
                    statusDiv.innerHTML =
                        '<div class="status error">‚ùå Could not open window. Please allow popups.</div>';
                    return;
                }

                // Wait for app to load
                setTimeout(() => {
                    try {
                        const win = testWindow;

                        // Check SessionManager
                        const hasSessionManager = typeof win.SessionManager !== 'undefined';
                        const hasRestoreWindowStack =
                            hasSessionManager &&
                            typeof win.SessionManager.restoreSession === 'function';

                        // Check __zIndexManager
                        const hasZIndexManager = typeof win.__zIndexManager !== 'undefined';
                        const hasRestoreMethod =
                            hasZIndexManager &&
                            typeof win.__zIndexManager.restoreWindowStack === 'function';
                        const hasGetStackMethod =
                            hasZIndexManager &&
                            typeof win.__zIndexManager.getWindowStack === 'function';

                        let html = '<h3>Implementation Check:</h3>';
                        html += `<div class="status ${hasSessionManager ? 'success' : 'error'}">`;
                        html += hasSessionManager ? '‚úÖ' : '‚ùå';
                        html += ` SessionManager: ${hasSessionManager ? 'Found' : 'Not Found'}</div>`;

                        html += `<div class="status ${hasRestoreWindowStack ? 'success' : 'error'}">`;
                        html += hasRestoreWindowStack ? '‚úÖ' : '‚ùå';
                        html += ` SessionManager.restoreSession: ${hasRestoreWindowStack ? 'Found' : 'Not Found'}</div>`;

                        html += `<div class="status ${hasZIndexManager ? 'success' : 'error'}">`;
                        html += hasZIndexManager ? '‚úÖ' : '‚ùå';
                        html += ` __zIndexManager: ${hasZIndexManager ? 'Found' : 'Not Found'}</div>`;

                        html += `<div class="status ${hasRestoreMethod ? 'success' : 'error'}">`;
                        html += hasRestoreMethod ? '‚úÖ' : '‚ùå';
                        html += ` __zIndexManager.restoreWindowStack: ${hasRestoreMethod ? 'Found' : 'Not Found'}</div>`;

                        html += `<div class="status ${hasGetStackMethod ? 'success' : 'error'}">`;
                        html += hasGetStackMethod ? '‚úÖ' : '‚ùå';
                        html += ` __zIndexManager.getWindowStack: ${hasGetStackMethod ? 'Found' : 'Not Found'}</div>`;

                        // Test the actual functionality
                        if (hasZIndexManager && hasGetStackMethod) {
                            // Open two windows
                            win.API.window.open('about-modal');
                            setTimeout(() => {
                                win.API.window.open('settings-modal');

                                setTimeout(() => {
                                    // Get initial stack
                                    const stack1 = win.__zIndexManager.getWindowStack();
                                    html += `<div class="status info">Initial stack: <pre>${JSON.stringify(stack1, null, 2)}</pre></div>`;

                                    // Bring about-modal to front
                                    const aboutHeader = win.document.querySelector(
                                        '#about-modal .draggable-header'
                                    );
                                    if (aboutHeader) {
                                        aboutHeader.click();

                                        setTimeout(() => {
                                            const stack2 = win.__zIndexManager.getWindowStack();
                                            html += `<div class="status info">After click: <pre>${JSON.stringify(stack2, null, 2)}</pre></div>`;

                                            // Check if about-modal is last in stack (on top)
                                            const aboutIsOnTop =
                                                stack2[stack2.length - 1] === 'about-modal';
                                            html += `<div class="status ${aboutIsOnTop ? 'success' : 'error'}">`;
                                            html += aboutIsOnTop ? '‚úÖ' : '‚ùå';
                                            html += ` About modal on top: ${aboutIsOnTop}</div>`;

                                            // Save session
                                            win.SessionManager.saveAll({ immediate: true });

                                            // Check localStorage
                                            const sessionData =
                                                localStorage.getItem('windowInstancesSession');
                                            if (sessionData) {
                                                const parsed = JSON.parse(sessionData);
                                                const hasWindowStack = Array.isArray(
                                                    parsed.windowStack
                                                );
                                                html += `<div class="status ${hasWindowStack ? 'success' : 'error'}">`;
                                                html += hasWindowStack ? '‚úÖ' : '‚ùå';
                                                html += ` windowStack saved: ${hasWindowStack}</div>`;

                                                if (hasWindowStack) {
                                                    html += `<div class="status info">Saved stack: <pre>${JSON.stringify(parsed.windowStack, null, 2)}</pre></div>`;
                                                }
                                            }

                                            html +=
                                                '<div class="status success">‚úÖ Now reload the main app and check if About stays on top!</div>';
                                            statusDiv.innerHTML = html;
                                        }, 200);
                                    } else {
                                        html +=
                                            '<div class="status error">‚ùå Could not find about-modal header</div>';
                                        statusDiv.innerHTML = html;
                                    }
                                }, 200);
                            }, 200);
                        } else {
                            statusDiv.innerHTML =
                                html +
                                '<div class="status error">‚ùå Missing required methods</div>';
                        }
                    } catch (err) {
                        statusDiv.innerHTML = `<div class="status error">‚ùå Error: ${err.message}</div>`;
                    }
                }, 2000);
            }
        </script>
    </body>
</html>
